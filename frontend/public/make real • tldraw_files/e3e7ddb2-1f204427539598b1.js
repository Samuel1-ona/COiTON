"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[155],{418:function(e,t,i){i.d(t,{M:function(){return Editor}});var s=i(9502),r=i(6934),a=i(3112),n=i(8729),h=i(7217),o=i(9968),p=i(7655),d=i(696),l=i(5404),g=i(4204),u=i(1986),c=i(7684),S=i(224),f=i(6166),m=i(7539),y=i(1230),I=i(5279),P=i(1605),C=i(853),_=i(7556),w=i(1034),x=i(6912),b=i(9078),T=i(4211),v=i(829),A=i(106),B=i(7055),E=i(7252),F=i(5084),k=i(6076),M=i(3197),O=i(6541),R=i(6393),z=i(4214),U=i(7761),K=i(3308),V=i(9040),D=Object.defineProperty,L=Object.getOwnPropertyDescriptor,__decorateClass=(e,t,i,s)=>{for(var r,a=s>1?void 0:s?L(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(a=(s?r(t,i,a):r(a))||a);return s&&a&&D(t,i,a),a};let Editor=class Editor extends n.EventEmitter{constructor({store:e,user:t,shapeUtils:i,tools:s,getContainer:n,initialState:p,inferDarkMode:d}){super(),this.store=e,this.snaps=new k.f(this),this.user=new R.K(t??(0,h.L)(),d??!1),this.getContainer=n??(()=>document.body),this.textMeasure=new M.R(this);let NewRoot=class NewRoot extends V.m{static initial=p??""};this.root=new NewRoot(this),this.root.children={};let l=(0,o.m)(i),g=new Set(Object.keys(e.schema.types.shape.migrations.subTypeMigrations));for(let e of l){if(!g.has(e.type))throw Error(`Editor and store have different shapes: "${e.type}" was passed into the editor but not the schema`);g.delete(e.type)}if(g.size>0)throw Error(`Editor and store have different shapes: "${[...g][0]}" is present in the store schema but not provided to the editor`);let u={},c={},S=new Map;for(let e of l){let t=new e(this);u[e.type]=t;let i=(0,r.DR)(e.props??{});for(let t of(c[e.type]=i,i.keys()))if(S.has(t.id)){if(S.get(t.id)!==t)throw Error(`Multiple style props with id "${t.id}" in use. Style prop IDs must be unique.`)}else S.set(t.id,t)}for(let e of(this.shapeUtils=u,this.styleProps=c,[...s])){if((0,a.nr)(this.root.children,e.id))throw Error(`Can't override tool with id "${e.id}"`);this.root.children[e.id]=new e(this,this.root)}this.environment=new A.l(this),this.scribbles=new E.o(this);let f=new Set,reparentArrow=e=>{let t,i,s;let r=this.getShape(e);if(!r)return;let{start:n,end:h}=r.props,o="binding"===n.type?this.getShape(n.boundShapeId):void 0,p="binding"===h.type?this.getShape(h.boundShapeId):void 0,d=this.getAncestorPageId(r);if(!d)return;if(o&&p)t=this.findCommonAncestor([o,p])??d;else{if(!o&&!p)return;let e=(o||p)?.parentId;t=e&&e===r.parentId?r.parentId:d}t&&t!==r.parentId&&this.reparentShapes([e],t);let l=this.getShape(e);if(!l)throw Error("no reparented arrow");let g=this.getShapeNearestSibling(l,o),u=this.getShapeNearestSibling(l,p);if(g&&u)i=g.index>u.index?g:u;else if(g&&!u)i=g;else{if(!u||g)return;i=u}let c=this.getSortedChildIdsForParent(i.parentId).map(e=>this.getShape(e)).filter(e=>e.index>i.index);if(c.length){let e=c.find(e=>"arrow"!==e.type);if(l.index>i.index&&(!e||l.index<e.index))return;s=(0,a.eI)(i.index,c[0].index)}else s=(0,a._L)(i.index);s!==l.index&&this.updateShapes([{id:e,type:"arrow",index:s}])},unbindArrowTerminal=(e,t)=>{let{x:i,y:s}=(0,U.Qs)(this,e)[t];this.store.put([{...e,props:{...e.props,[t]:{type:"point",x:i,y:s}}}])},arrowDidUpdate=e=>{for(let t of["start","end"]){let i=e.props[t];if("binding"!==i.type)continue;let s=this.getShape(i.boundShapeId),r=this.getAncestorPageId(e)===this.getAncestorPageId(s);s&&r||unbindArrowTerminal(e,t)}reparentArrow(e.id)},cleanupInstancePageState=(e,t)=>{let i=null,s=e.selectedShapeIds.filter(e=>!t.has(e));s.length!==e.selectedShapeIds.length&&(i||(i={...e}),i.selectedShapeIds=s);let r=e.erasingShapeIds.filter(e=>!t.has(e));r.length!==e.erasingShapeIds.length&&(i||(i={...e}),i.erasingShapeIds=r),e.hoveredShapeId&&t.has(e.hoveredShapeId)&&(i||(i={...e}),i.hoveredShapeId=null),e.editingShapeId&&t.has(e.editingShapeId)&&(i||(i={...e}),i.editingShapeId=null);let a=e.hintingShapeIds.filter(e=>!t.has(e));return a.length!==e.hintingShapeIds.length&&(i||(i={...e}),i.hintingShapeIds=a),e.focusedGroupId&&t.has(e.focusedGroupId)&&(i||(i={...e}),i.focusedGroupId=null),i};if(this.sideEffects=new F.Y(this),this.sideEffects.registerBatchCompleteHandler(()=>{for(let e of f){f.delete(e);let t=this.getShape(e);if(!t)continue;let i=this.getShapeUtil(t),s=i.onChildrenChange?.(t);s?.length&&this.updateShapes(s,{squashing:!0})}this.emit("update")}),this.sideEffects.registerBeforeDeleteHandler("shape",e=>{e.parentId&&(0,r.YT)(e.parentId)&&f.add(e.parentId);let t=this._getArrowBindingsIndex().get()[e.id];if(t?.length)for(let{arrowId:e,handleId:i}of t){let t=this.getShape(e);t&&unbindArrowTerminal(t,i)}let i=new Set([e.id]),s=(0,a.oA)(this.getPageStates().map(e=>cleanupInstancePageState(e,i)));s.length&&this.store.put(s)}),this.sideEffects.registerBeforeDeleteHandler("page",e=>{if(this.getInstanceState().currentPageId!==e.id)return;let t=this.getPages().find(t=>t.id!==e.id)?.id;if(!t)return;this.store.put([{...this.getInstanceState(),currentPageId:t}]);let i=r.AN.createId(e.id),s=r.iS.createId(e.id);this.store.remove([i,s])}),this.sideEffects.registerAfterChangeHandler("shape",(e,t)=>{if(this.isShapeOfType(t,"arrow")&&arrowDidUpdate(t),e.parentId!==t.parentId){let reparentBoundArrows=e=>{let t=this._getArrowBindingsIndex().get()[e];if(t?.length)for(let e of t)reparentArrow(e.arrowId)};reparentBoundArrows(t.id),this.visitDescendants(t.id,reparentBoundArrows)}if(e.parentId!==t.parentId&&(0,r.r5)(t.parentId)){let i=new Set([e.id]);for(let s of(this.visitDescendants(e.id,e=>{i.add(e)}),this.getPageStates())){if(s.pageId===t.parentId)continue;let e=cleanupInstancePageState(s,i);e&&this.store.put([e])}}e.parentId&&(0,r.YT)(e.parentId)&&f.add(e.parentId),t.parentId!==e.parentId&&(0,r.YT)(t.parentId)&&f.add(t.parentId)}),this.sideEffects.registerAfterChangeHandler("instance_page_state",(e,t)=>{if(e?.selectedShapeIds!==t?.selectedShapeIds){let e=t.selectedShapeIds.filter(e=>{let i=this.getShape(e)?.parentId;for(;(0,r.YT)(i);){if(t.selectedShapeIds.includes(i))return!1;i=this.getShape(i)?.parentId}return!0}),i=null;if(e.length>0){let t=this.findCommonAncestor((0,a.oA)(e.map(e=>this.getShape(e))),e=>this.isShapeOfType(e,"group"));t&&(i=t)}else t?.focusedGroupId&&(i=t.focusedGroupId);(e.length!==t.selectedShapeIds.length||i!==t.focusedGroupId)&&this.store.put([{...t,selectedShapeIds:e,focusedGroupId:i??null}])}}),this.sideEffects.registerAfterCreateHandler("shape",e=>{this.isShapeOfType(e,"arrow")&&arrowDidUpdate(e)}),this.sideEffects.registerAfterCreateHandler("page",e=>{let t=r.AN.createId(e.id),i=r.iS.createId(e.id);this.store.has(t)||this.store.put([r.AN.create({id:t})]),this.store.has(i)||this.store.put([r.iS.create({id:i,pageId:e.id})])}),this._currentPageShapeIds=(0,T.Q)(this.store,()=>this.getCurrentPageId()),this._parentIdsToChildIds=(0,b.s)(this.store),this.disposables.add(this.store.listen(e=>{this.emit("change",e)})),this.store.ensureStoreIsUsable(),this._setInstancePageState({editingShapeId:null,hoveredShapeId:null,erasingShapeIds:[]},{ephemeral:!0}),p&&void 0===this.root.children[p])throw Error(`No state found for initialState "${p}".`);this.root.enter(void 0,"initial"),this.getInstanceState().followingUserId&&this.stopFollowingUser(),this.updateRenderingBounds(),requestAnimationFrame(()=>{this._tickManager.start()})}store;root;disposables=new Set;_tickManager=new O.r(this);snaps;user;textMeasure;environment;scribbles;getContainer;sideEffects;dispose(){this.disposables.forEach(e=>e()),this.disposables.clear()}shapeUtils;styleProps;getShapeUtil(e){let t="string"==typeof e?e:e.type,i=(0,a.eg)(this.shapeUtils,t);return(0,a.hu)(i,`No shape util found for type "${t}"`),i}history=new B.E(this,e=>{this.annotateError(e,{origin:"history.batch",willCrashApp:!0}),this.crash(e)});undo(){return this.history.undo(),this}getCanUndo(){return this.history.getNumUndos()>0}redo(){return this.history.redo(),this}getCanRedo(){return this.history.getNumRedos()>0}mark(e,t,i){return this.history.mark(e,t,i),this}bail(){return this.history.bail(),this}bailToMark(e){return this.history.bailToMark(e),this}batch(e){return this.history.batch(e),this}_getArrowBindingsIndex(){return(0,x.w)(this)}getArrowsBoundTo(e){return this._getArrowBindingsIndex().get()[e]||s.LZ}getArrowInfoCache(){return this.store.createComputedCache("arrow infoCache",e=>(0,U.el)(e)?(0,K.r)(this,e):(0,z.p)(this,e))}getArrowInfo(e){let t="string"==typeof e?e:e.id;return this.getArrowInfoCache().get(t)}annotateError(e,{origin:t,willCrashApp:i,tags:s,extras:r}){let n=this.createErrorAnnotations(t,i);return(0,a.lw)(e,{tags:{...n.tags,...s},extras:{...n.extras,...r}}),i&&this.store.markAsPossiblyCorrupted(),this}createErrorAnnotations(e,t){try{let i=this.getEditingShapeId();return{tags:{origin:e,willCrashApp:t},extras:{activeStateNode:this.root.getPath(),selectedShapes:this.getSelectedShapes(),editingShape:i?this.getShape(i):void 0,inputs:this.inputs}}}catch{return{tags:{origin:e,willCrashApp:t},extras:{}}}}_crashingError=null;getCrashingError(){return this._crashingError}crash(e){return this._crashingError=e,this.store.markAsPossiblyCorrupted(),this.emit("crash",{error:e}),this}getPath(){return this.root.getPath().split("root.")[1]}isIn(e){let t=e.split(".").reverse(),i=this.root;for(;t.length>0;){let e=t.pop();if(!e)return!0;let s=i.getCurrent();if(s?.id===e){if(0===t.length)return!0;i=s;continue}break}return!1}isInAny(...e){return e.some(e=>this.isIn(e))}setCurrentTool(e,t={}){return this.root.transition(e,t),this}getCurrentTool(){return this.root.getCurrent()}getCurrentToolId(){let e=this.getCurrentTool();return e?e.getCurrentToolIdMask()??e.id:""}getStateDescendant(e){let t=e.split(".").reverse(),i=this.root;for(;t.length>0;){let e=t.pop();if(!e)break;let s=i.children?.[e];if(!s)return;i=s}return i}getDocumentSettings(){return this.store.get(r.G4)}updateDocumentSettings(e){return this.store.put([{...this.getDocumentSettings(),...e}]),this}getInstanceState(){return this.store.get(r.PQ)}updateInstanceState(e,t){return this._updateInstanceState(e,{ephemeral:!0,squashing:!0,...t}),void 0!==e.isChangingStyle&&(clearTimeout(this._isChangingStyleTimeout),!0===e.isChangingStyle&&(this._isChangingStyleTimeout=setTimeout(()=>{this.updateInstanceState({isChangingStyle:!1},{ephemeral:!0})},2e3))),this}_updateInstanceState=this.history.createCommand("updateInstanceState",(e,t)=>{let i=this.store.get(this.getInstanceState().id),s={...i,...e};return{data:{prev:i,next:s},ephemeral:!1,squashing:!1,...t}},{do:({next:e})=>{this.store.put([e])},undo:({prev:e})=>{this.store.put([e])},squash:({prev:e},{next:t})=>({prev:e,next:t})});_isChangingStyleTimeout=-1;getOpenMenus(){return this.getInstanceState().openMenus}addOpenMenu(e){let t=new Set(this.getOpenMenus());return t.has(e)||(t.add(e),this.updateInstanceState({openMenus:[...t]})),this}deleteOpenMenu(e){let t=new Set(this.getOpenMenus());return t.has(e)&&(t.delete(e),this.updateInstanceState({openMenus:[...t]})),this}clearOpenMenus(){return this.getOpenMenus().length&&this.updateInstanceState({openMenus:[]}),this}getIsMenuOpen(){return this.getOpenMenus().length>0}setCursor=e=>(this.updateInstanceState({cursor:{...this.getInstanceState().cursor,...e}},{ephemeral:!0}),this);getPageStates(){return this._getPageStatesQuery().get()}_getPageStatesQuery(){return this.store.query.records("instance_page_state")}getCurrentPageState(){return this.store.get(this._getCurrentPageStateId())}_getCurrentPageStateId(){return r.iS.createId(this.getCurrentPageId())}updateCurrentPageState(e,t){return this._setInstancePageState(e,t),this}_setInstancePageState=this.history.createCommand("setInstancePageState",(e,t)=>{let i=this.store.get(e.id??this.getCurrentPageState().id);return{data:{prev:i,partial:e},...t}},{do:({prev:e,partial:t})=>{this.store.update(e.id,e=>({...e,...t}))},undo:({prev:e})=>{this.store.update(e.id,()=>e)}});getSelectedShapeIds(){return this.getCurrentPageState().selectedShapeIds}getSelectedShapes(){let{selectedShapeIds:e}=this.getCurrentPageState();return(0,a.oA)(e.map(e=>this.store.get(e)))}setSelectedShapes(e,t){let i=e.map(e=>"string"==typeof e?e:e.id);return this._setSelectedShapes(i,t),this}_setSelectedShapes=this.history.createCommand("setSelectedShapes",(e,t)=>{let{selectedShapeIds:i}=this.getCurrentPageState(),s=new Set(i);return e.length===s.size&&e.every(e=>s.has(e))?null:{data:{selectedShapeIds:e,prevSelectedShapeIds:i},preservesRedoStack:!0,...t}},{do:({selectedShapeIds:e})=>{this.store.put([{...this.getCurrentPageState(),selectedShapeIds:e}])},undo:({prevSelectedShapeIds:e})=>{this.store.put([{...this.getCurrentPageState(),selectedShapeIds:e}])},squash:({prevSelectedShapeIds:e},{selectedShapeIds:t})=>({selectedShapeIds:t,prevSelectedShapeIds:e})});isAncestorSelected(e){let t="string"==typeof e?e:e?.id??null,i=this.getShape(t);if(!i)return!1;let s=this.getSelectedShapeIds();return!!this.findShapeAncestor(i,e=>s.includes(e.id))}select(...e){let t="string"==typeof e[0]?e:e.map(e=>e.id);return this.setSelectedShapes(t),this}deselect(...e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=this.getSelectedShapeIds();return i.length>0&&t.length>0&&this.setSelectedShapes(i.filter(e=>!t.includes(e))),this}selectAll(){let e=this.getSortedChildIdsForParent(this.getCurrentPageId());return e.length<=0||this.setSelectedShapes(this._getUnlockedShapeIds(e)),this}selectNone(){return this.getSelectedShapeIds().length>0&&this.setSelectedShapes([]),this}getOnlySelectedShape(){let e=this.getSelectedShapes();return 1===e.length?e[0]:null}getSelectionPageBounds(){let e=this.getCurrentPageState().selectedShapeIds;return 0===e.length?null:d.xu.Common((0,a.oA)(e.map(e=>this.getShapePageBounds(e))))}getSelectionRotation(){let e=this.getSelectedShapeIds();if(0===e.length)return 0;if(1===e.length)return this.getShapePageTransform(this.getSelectedShapeIds()[0]).rotation();let t=e.map(e=>this.getShapePageTransform(e).rotation());return t.every(e=>Math.abs(e-t[0])<Math.PI/180)?this.getShapePageTransform(e[0]).rotation():0}getSelectionRotatedPageBounds(){let e=this.getSelectedShapeIds();if(0===e.length)return;let t=this.getSelectionRotation();if(0===t)return this.getSelectionPageBounds();if(1===e.length){let t=this.getShapeGeometry(e[0]).bounds.clone(),i=this.getShapePageTransform(e[0]);return t.point=i.applyToPoint(t.point),t}let i=d.xu.FromPoints(this.getSelectedShapeIds().flatMap(e=>{let t=this.getShapePageTransform(e);return t?t.applyToPoints(this.getShapeGeometry(e).vertices):[]}).map(e=>g.B.Rot(e,-t)));return i.point=i.point.rot(t),i}getFocusedGroupId(){return this.getCurrentPageState().focusedGroupId??this.getCurrentPageId()}getFocusedGroup(){let e=this.getFocusedGroupId();return e?this.getShape(e):void 0}setFocusedGroup(e){let t="string"==typeof e?e:e?.id??null;if(null!==t){let e=this.getShape(t);if(!e)throw Error(`Editor.setFocusedGroup: Shape with id ${t} does not exist`);if(!this.isShapeOfType(e,"group"))throw Error(`Editor.setFocusedGroup: Cannot set focused group to shape of type ${e.type}`)}return t===this.getFocusedGroupId()||this._setFocusedGroupId(t),this}_setFocusedGroupId=this.history.createCommand("setFocusedGroupId",e=>{let t=this.getCurrentPageState().focusedGroupId;if(t!==e)return{data:{prev:t,next:e},preservesRedoStack:!0,squashing:!0}},{do:({next:e})=>{this.store.update(this.getCurrentPageState().id,t=>({...t,focusedGroupId:e}))},undo:({prev:e})=>{this.store.update(this.getCurrentPageState().id,t=>({...t,focusedGroupId:e}))},squash:({prev:e},{next:t})=>({prev:e,next:t})});popFocusedGroupId(){let e=this.getFocusedGroup();if(e){let t=this.findShapeAncestor(e,e=>this.isShapeOfType(e,"group"));this.setFocusedGroup(t?.id??null),this.select(e.id)}else this.setFocusedGroup(null),this.selectNone();return this}getEditingShapeId(){return this.getCurrentPageState().editingShapeId}getEditingShape(){let e=this.getEditingShapeId();return e?this.getShape(e):void 0}setEditingShape(e){let t="string"==typeof e?e:e?.id??null;if(t!==this.getEditingShapeId()){if(t){let e=this.getShape(t);if(e&&this.getShapeUtil(e).canEdit(e))return this._setInstancePageState({editingShapeId:t}),this}this._setInstancePageState({editingShapeId:null})}return this}getHoveredShapeId(){return this.getCurrentPageState().hoveredShapeId}getHoveredShape(){let e=this.getHoveredShapeId();return e?this.getShape(e):void 0}setHoveredShape(e){let t="string"==typeof e?e:e?.id??null;return t===this.getHoveredShapeId()||this.updateCurrentPageState({hoveredShapeId:t},{ephemeral:!0}),this}getHintingShapeIds(){return this.getCurrentPageState().hintingShapeIds}getHintingShape(){let e=this.getHintingShapeIds();return(0,a.oA)(e.map(e=>this.getShape(e)))}setHintingShapes(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);return this.updateCurrentPageState({hintingShapeIds:(0,a.D8)(t)},{ephemeral:!0}),this}getErasingShapeIds(){return this.getCurrentPageState().erasingShapeIds}getErasingShapes(){let e=this.getErasingShapeIds();return(0,a.oA)(e.map(e=>this.getShape(e)))}setErasingShapes(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);t.sort();let i=this.getErasingShapeIds();if(t.length===i.length){for(let e=0;e<t.length;e++)if(t[e]!==i[e]){this._setInstancePageState({erasingShapeIds:t},{ephemeral:!0});break}}else this._setInstancePageState({erasingShapeIds:t},{ephemeral:!0});return this}getCroppingShapeId(){return this.getCurrentPageState().croppingShapeId}setCroppingShape(e){let t="string"==typeof e?e:e?.id??null;if(t!==this.getCroppingShapeId()){if(t){let e=this.getShape(t),i=this.getShapeUtil(e);e&&i.canCrop(e)&&this.updateCurrentPageState({croppingShapeId:t})}else this.updateCurrentPageState({croppingShapeId:null})}return this}getCameraId(){return r.AN.createId(this.getCurrentPageId())}getCamera(){return this.store.get(this.getCameraId())}getZoomLevel(){return this.getCamera().z}_setCamera(e){let t=this.getCamera();return t.x===e.x&&t.y===e.y&&t.z===e.z||this.batch(()=>{this.store.put([{...t,...e}]);let{currentScreenPoint:i}=this.inputs,{screenBounds:s}=this.store.unsafeGetWithoutCapture(r.PQ);this.dispatch({type:"pointer",target:"canvas",name:"pointer_move",point:g.B.AddXY(i,s.x,s.y),pointerId:p.CK.CAMERA_MOVE,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,shiftKey:this.inputs.shiftKey,button:0,isPen:this.getInstanceState().isPenMode??!1}),this._tickCameraState()}),this}setCamera(e,t){let i=Number.isFinite(e.x)?e.x:0,s=Number.isFinite(e.y)?e.y:0,r=Number.isFinite(e.z)?e.z:this.getZoomLevel();if(this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser(),t){let{width:e,height:a}=this.getViewportScreenBounds();return this._animateToViewport(new d.xu(-i,-s,e/r,a/r),t)}return this._setCamera({x:i,y:s,z:r}),this}centerOnPoint(e,t){if(!this.getInstanceState().canMoveCamera)return this;let{width:i,height:s}=this.getViewportPageBounds();return this.setCamera({x:-(e.x-i/2),y:-(e.y-s/2),z:this.getCamera().z},t),this}zoomToContent(){let e=this.getSelectionPageBounds()??this.getCurrentPageBounds();return e&&this.zoomToBounds(e,{targetZoom:Math.min(1,this.getZoomLevel()),duration:220}),this}zoomToFit(e){if(!this.getInstanceState().canMoveCamera)return this;let t=[...this.getCurrentPageShapeIds()];if(t.length<=0)return this;let i=d.xu.Common((0,a.oA)(t.map(e=>this.getShapePageBounds(e))));return this.zoomToBounds(i,e),this}resetZoom(e=this.getViewportScreenCenter(),t){if(!this.getInstanceState().canMoveCamera)return this;let{x:i,y:s,z:r}=this.getCamera(),{x:a,y:n}=e;return this.setCamera({x:i+(a/1-a)-(a/r-a),y:s+(n/1-n)-(n/r-n),z:1},t),this}zoomIn(e=this.getViewportScreenCenter(),t){if(!this.getInstanceState().canMoveCamera)return this;let{x:i,y:s,z:r}=this.getCamera(),a=p.sZ;for(let e=1;e<p.E.length;e++){let t=p.E[e-1],i=p.E[e];if(!(i-r<=(i-t)/2)){a=i;break}}let{x:n,y:h}=e;return this.setCamera({x:i+(n/a-n)-(n/r-n),y:s+(h/a-h)-(h/r-h),z:a},t),this}zoomOut(e=this.getViewportScreenCenter(),t){if(!this.getInstanceState().canMoveCamera)return this;let{x:i,y:s,z:r}=this.getCamera(),a=p.Zj;for(let e=p.E.length-1;e>0;e--){let t=p.E[e-1],i=p.E[e];if(!(i-r>=(i-t)/2)){a=t;break}}let{x:n,y:h}=e;return this.setCamera({x:i+(n/a-n)-(n/r-n),y:s+(h/a-h)-(h/r-h),z:a},t),this}zoomToSelection(e){if(!this.getInstanceState().canMoveCamera)return this;let t=this.getSelectionPageBounds();return t&&this.zoomToBounds(t,{targetZoom:Math.max(1,this.getZoomLevel()),...e}),this}panZoomIntoView(e,t){if(!this.getInstanceState().canMoveCamera||e.length<=0)return this;let i=d.xu.Common((0,a.oA)(e.map(e=>this.getShapePageBounds(e)))),s=this.getViewportPageBounds();if(s.h<i.h||s.w<i.w)this.zoomToBounds(i,{targetZoom:this.getCamera().z,...t});else{let e=this.getViewportPageBounds().clone().expandBy(-32/this.getZoomLevel()),s=0,r=0;e.maxY<i.maxY?r=e.maxY-i.maxY:e.minY>i.minY&&(r=e.minY-i.minY),e.maxX<i.maxX?s=e.maxX-i.maxX:e.minX>i.minX&&(s=e.minX-i.minX);let a=this.getCamera();this.setCamera({x:a.x+s,y:a.y+r,z:a.z},t)}return this}zoomToBounds(e,t){if(!this.getInstanceState().canMoveCamera)return this;let i=this.getViewportScreenBounds(),s=t?.inset??Math.min(256,.28*i.width),r=(0,f.uZ)(Math.min((i.width-s)/e.width,(i.height-s)/e.height),p.Zj,p.sZ);return t?.targetZoom!==void 0&&(r=Math.min(t.targetZoom,r)),this.setCamera({x:-e.minX+(i.width-e.width*r)/2/r,y:-e.minY+(i.height-e.height*r)/2/r,z:r},t),this}pan(e,t){if(!this.getInstanceState().canMoveCamera)return this;let{x:i,y:s,z:r}=this.getCamera();return this.setCamera({x:i+e.x/r,y:s+e.y/r,z:r},t),this}stopCameraAnimation(){return this.emit("stop-camera-animation"),this}_viewportAnimation=null;_animateViewport(e){if(!this._viewportAnimation)return;let cancel=()=>{this.removeListener("tick",this._animateViewport),this.removeListener("stop-camera-animation",cancel),this._viewportAnimation=null};this.once("stop-camera-animation",cancel),this._viewportAnimation.elapsed+=e;let{elapsed:t,easing:i,duration:s,start:r,end:a}=this._viewportAnimation;if(t>s){this._setCamera({x:-a.x,y:-a.y,z:this.getViewportScreenBounds().width/a.width}),cancel();return}let n=s-t,h=i(1-n/s),o=r.minX+(a.minX-r.minX)*h,p=r.minY+(a.minY-r.minY)*h,d=r.maxX+(a.maxX-r.maxX)*h;this._setCamera({x:-o,y:-p,z:this.getViewportScreenBounds().width/(d-o)})}_animateToViewport(e,t={}){let{duration:i=0,easing:s=u.L.easeInOutCubic}=t,r=this.user.getAnimationSpeed(),a=this.getViewportPageBounds();return(this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser(),0===i||0===r)?this._setCamera({x:-e.x,y:-e.y,z:this.getViewportScreenBounds().width/e.width}):(this._viewportAnimation={elapsed:0,duration:i/r,easing:s,start:a.clone(),end:e.clone()},this.addListener("tick",this._animateViewport),this)}slideCamera(e={}){if(!this.getInstanceState().canMoveCamera)return this;this.stopCameraAnimation();let t=this.user.getAnimationSpeed();if(0===t)return this;let{speed:i,friction:s,direction:r,speedThreshold:a=.01}=e,n=Math.min(i,1),cancel=()=>{this.removeListener("tick",moveCamera),this.removeListener("stop-camera-animation",cancel)};this.once("stop-camera-animation",cancel);let moveCamera=e=>{let{x:t,y:i,z:h}=this.getCamera(),o=g.B.Mul(r,n*e/h);(n*=1-s)<a?cancel():this._setCamera({x:t+o.x,y:i+o.y,z:h})};return this.addListener("tick",moveCamera),this}animateToUser(e){let t=this.store.query.records("instance_presence",()=>({userId:{eq:e}})),i=[...t.get()].sort((e,t)=>e.lastActivityTimestamp-t.lastActivityTimestamp).pop();return i&&this.batch(()=>{null!==this.getInstanceState().followingUserId&&this.stopFollowingUser();let t=i.currentPageId===this.getCurrentPageId();t||this.setCurrentPage(i.currentPageId),this.centerOnPoint(i.cursor,t?{duration:500}:void 0);let{highlightedUserIds:s}=this.getInstanceState();this.updateInstanceState({highlightedUserIds:[...s,e]}),setTimeout(()=>{let t=[...this.getInstanceState().highlightedUserIds],i=t.indexOf(e);i<0||(t.splice(i,1),this.updateInstanceState({highlightedUserIds:t}))},p.O8)}),this}animateToShape(e,t=p.Xy){if(!this.getInstanceState().canMoveCamera)return this;let i=this.getViewportScreenBounds().clone().expandBy(-32),s=i.width/i.height,r=this.getShapePageBounds(e);if(!r)return this;let a=r.width/r.height,n=r.clone(),h=r.width/i.width;return n.width+=(i.minX+i.maxX)*h,n.height+=(i.minY+i.maxY)*h,n.x-=i.minX*h,n.y-=i.minY*h,a>s?(n.height=r.width/s,n.y-=(n.height-r.height)/2):(n.width=r.height*s,n.x-=(n.width-r.width)/2),this._animateToViewport(n,t)}_willSetInitialBounds=!0;_wasInset=!1;updateViewportScreenBounds(e,t=!1){e.width=Math.max(e.width,1),e.height=Math.max(e.height,1);let i=[0!==e.minY,document.body.scrollWidth!==e.maxX,document.body.scrollHeight!==e.maxY,0!==e.minX],s=e.equals(this.getViewportScreenBounds()),{_willSetInitialBounds:r}=this;if(s)this._willSetInitialBounds=!1;else if(r)this._willSetInitialBounds=!1,this.updateInstanceState({screenBounds:e.toJson(),insets:i},{squashing:!0,ephemeral:!0});else if(t&&!this.getInstanceState().followingUserId){let t=this.getViewportPageCenter();this.updateInstanceState({screenBounds:e.toJson(),insets:i},{squashing:!0,ephemeral:!0}),this.centerOnPoint(t)}else this.updateInstanceState({screenBounds:e.toJson(),insets:i},{squashing:!0,ephemeral:!0});return this._tickCameraState(),this.updateRenderingBounds(),this}getViewportScreenBounds(){let{x:e,y:t,w:i,h:s}=this.getInstanceState().screenBounds;return new d.xu(e,t,i,s)}getViewportScreenCenter(){let e=this.getViewportScreenBounds();return new g.B(e.midX-e.minX,e.midY-e.minY)}getViewportPageBounds(){let{w:e,h:t}=this.getViewportScreenBounds(),{x:i,y:s,z:r}=this.getCamera();return new d.xu(-i,-s,e/r,t/r)}getViewportPageCenter(){return this.getViewportPageBounds().center}screenToPage(e){let{screenBounds:t}=this.store.unsafeGetWithoutCapture(r.PQ),{x:i,y:s,z:a=1}=this.getCamera();return{x:(e.x-t.x)/a-i,y:(e.y-t.y)/a-s,z:e.z??.5}}pageToScreen(e){let{screenBounds:t}=this.store.unsafeGetWithoutCapture(r.PQ),{x:i,y:s,z:a=1}=this.getCamera();return{x:(e.x+i)*a+t.x,y:(e.y+s)*a+t.y,z:e.z??.5}}startFollowingUser(e){let t=this.store.query.records("instance_presence",()=>({userId:{eq:e}})),i=this.user.getId();if(i||console.warn("You should set the userId for the current instance before following a user"),t.get().some(e=>e.followingUserId===i))return this;(0,s.ay)(()=>{this.stopFollowingUser(),this.updateInstanceState({followingUserId:e},{ephemeral:!0})});let cancel=()=>{this.removeListener("frame",moveTowardsUser),this.removeListener("stop-following",cancel)},r=!1,moveTowardsUser=()=>{let s=[...t.get()].sort((e,t)=>e.lastActivityTimestamp-t.lastActivityTimestamp).pop();if(!s){this.stopFollowingUser();return}let a=s.currentPageId===this.getCurrentPageId(),n=a?p.CN:1;if(!a){this.stopFollowingUser(),this.setCurrentPage(s.currentPageId),this.startFollowingUser(e);return}let{center:h,width:o,height:l}=this.getViewportPageBounds(),u=d.xu.From(s.screenBounds),c=u.width/s.camera.z,S=u.height/s.camera.z,m=new g.B(c/2-s.camera.x,S/2-s.camera.y),y=s.followingUserId===i,I=o+(c-o)*n,P=l+(S-l)*n,C=(0,f.uZ)(this.getCamera().z*(y?l/P:Math.min(o/I,l/P)),p.Zj,p.sZ),_=this.getViewportScreenBounds().w/C,w=this.getViewportScreenBounds().h/C,x=m.sub(h),b=g.B.Add(h,g.B.Mul(x,n)),T=g.B.Sub(b,h).len(),v=Math.abs(C-this.getCamera().z);if(T<p.wi&&v<p.Ns){r=!0;return}r&&T<p.Qd&&v<p.RH||(r=!1,this.stopCameraAnimation(),this._setCamera({x:-(b.x-_/2),y:-(b.y-w/2),z:C}))};return this.once("stop-following",cancel),this.addListener("frame",moveTowardsUser),this}stopFollowingUser(){return this.updateInstanceState({followingUserId:null},{ephemeral:!0}),this.emit("stop-following"),this}_cameraState=(0,s.cn)("camera state","idle");getCameraState(){return this._cameraState.get()}_cameraStateTimeoutRemaining=0;_lastUpdateRenderingBoundsTimestamp=Date.now();_decayCameraStateTimeout=e=>{this._cameraStateTimeoutRemaining-=e,this._cameraStateTimeoutRemaining<=0&&(this.off("tick",this._decayCameraStateTimeout),this._cameraState.set("idle"),this.updateRenderingBounds())};_tickCameraState=()=>{this._cameraStateTimeoutRemaining=p.yV;let e=Date.now();"idle"===this._cameraState.__unsafe__getWithoutCapture()?(this._lastUpdateRenderingBoundsTimestamp=e,this._cameraState.set("moving"),this.on("tick",this._decayCameraStateTimeout)):e-this._lastUpdateRenderingBoundsTimestamp>p.aR&&this.updateRenderingBounds()};getUnorderedRenderingShapes(e){let t=[],i=2*p.kx,s=p.kx,r=this.getEditingShapeId(),a=this.getSelectedShapeIds(),n=this.getErasingShapeIds(),h=this.getRenderingBoundsExpanded(),o=Number.isFinite(this.renderingBoundsMargin),addShapeById=(d,l,g)=>{let u=this.getShape(d);if(!u)return;l*=u.opacity;let c=!1,S=!1,f=this.getShapeUtil(u),m=this.getShapeMaskedPageBounds(d);e&&((S=!g&&n.includes(d))&&(l*=.32),c=o&&f.canUnmount(u)&&r!==d&&(void 0===m||!h.includes(m)&&!a.includes(d))),t.push({id:d,shape:u,util:f,index:i,backgroundIndex:s,opacity:l,isCulled:c,maskedPageBounds:m}),i+=1,s+=1;let y=this.getSortedChildIdsForParent(d);if(!y.length)return;let I=null;for(let e of(f.providesBackgroundForChildren(u)&&(I=s,s=i,i+=p.kx),y))addShapeById(e,l,g||S);null!==I&&(s=I)},d=e?[this.getCurrentPage()]:this.getPages();for(let e of d)for(let t of this.getSortedChildIdsForParent(e.id))addShapeById(t,1,!1);return t}getRenderingShapes(){let e=this.getUnorderedRenderingShapes(!0);return e.sort(a.uv)}getRenderingBounds(){return this._renderingBounds.get()}_renderingBounds=(0,s.cn)("rendering viewport",new d.xu);getRenderingBoundsExpanded(){return this._renderingBoundsExpanded.get()}_renderingBoundsExpanded=(0,s.cn)("rendering viewport expanded",new d.xu);updateRenderingBounds(){let e=this.getViewportPageBounds();return e.equals(this._renderingBounds.__unsafe__getWithoutCapture())||(this._renderingBounds.set(e.clone()),Number.isFinite(this.renderingBoundsMargin)?this._renderingBoundsExpanded.set(e.clone().expandBy(this.renderingBoundsMargin/this.getZoomLevel())):this._renderingBoundsExpanded.set(e)),this}renderingBoundsMargin=100;_getAllPagesQuery(){return this.store.query.records("page")}getPages(){return this._getAllPagesQuery().get().sort(a.hl)}getCurrentPage(){return this.getPage(this.getCurrentPageId())}getCurrentPageId(){return this.getInstanceState().currentPageId}getPage(e){return this.store.get("string"==typeof e?e:e.id)}_currentPageShapeIds;getCurrentPageShapeIds(){return this._currentPageShapeIds.get()}getPageShapeIds(e){let t="string"==typeof e?e:e.id,i=this.store.query.exec("shape",{parentId:{eq:t}});return this.getShapeAndDescendantIds(i.map(e=>e.id))}setCurrentPage(e,t){let i="string"==typeof e?e:e.id;return this._setCurrentPageId(i,t),this}_setCurrentPageId=this.history.createCommand("setCurrentPage",(e,t)=>{if(!this.store.has(e)){console.error("Tried to set the current page id to a page that doesn't exist.");return}return this.stopFollowingUser(),{data:{toId:e,fromId:this.getCurrentPageId()},squashing:!0,preservesRedoStack:!0,...t}},{do:({toId:e})=>{if(this.store.has(e)){if(!this.getPageStates().find(t=>t.pageId===e)){let t=r.AN.create({id:r.AN.createId(e)});this.store.put([t,r.iS.create({id:r.iS.createId(e),pageId:e})])}this.store.put([{...this.getInstanceState(),currentPageId:e}]),this.updateRenderingBounds()}},undo:({fromId:e})=>{this.store.has(e)&&(this.store.put([{...this.getInstanceState(),currentPageId:e}]),this.updateRenderingBounds())},squash:({fromId:e},{toId:t})=>({toId:t,fromId:e})});updatePage(e,t){return this._updatePage(e,t),this}_updatePage=this.history.createCommand("updatePage",(e,t)=>{if(this.getInstanceState().isReadonly)return null;let i=this.getPage(e.id);return i?{data:{prev:i,partial:e},...t}:null},{do:({partial:e})=>{this.store.update(e.id,t=>({...t,...e}))},undo:({prev:e,partial:t})=>{this.store.update(t.id,()=>e)},squash:(e,t)=>({prev:{...e.prev,...t.prev},partial:t.partial})});createPage(e){return this._createPage(e),this}_createPage=this.history.createCommand("createPage",e=>{if(this.getInstanceState().isReadonly||this.getPages().length>=p.Et)return null;let t=this.getPages(),i=(0,P.u)(e.name??"Page 1",t.map(e=>e.name)),s=e.index;(!s||t.some(e=>e.index===s))&&(s=(0,a._L)(t[t.length-1].index));let n=r.ez.create({meta:{},...e,name:i,index:s}),h=r.AN.create({id:r.AN.createId(n.id)}),o=r.iS.create({id:r.iS.createId(n.id),pageId:n.id});return{data:{newPage:n,newTabPageState:o,newCamera:h}}},{do:({newPage:e,newTabPageState:t,newCamera:i})=>{this.store.put([e,i,t])},undo:({newPage:e,newTabPageState:t,newCamera:i})=>{1!==this.getPages().length&&this.store.remove([t.id,e.id,i.id])}});deletePage(e){let t="string"==typeof e?e:e.id;return this._deletePage(t),this}_deletePage=this.history.createCommand("delete_page",e=>{if(this.getInstanceState().isReadonly)return null;let t=this.getPages();if(1===t.length)return null;let i=this.getPage(e),s=this.getPageStates().filter(t=>t.pageId===e);if(!i)return null;if(e===this.getCurrentPageId()){let i=t.findIndex(t=>t.id===e),s=t[i-1]??t[i+1];this.setCurrentPage(s.id)}return{data:{id:e,deletedPage:i,deletedPageStates:s}}},{do:({deletedPage:e,deletedPageStates:t})=>{let i=this.getPages();if(1!==i.length){if(e.id===this.getCurrentPageId()){let t=i.findIndex(t=>t.id===e.id),s=i[t-1]??i[t+1];this.setCurrentPage(s.id)}this.store.remove(t.map(e=>e.id)),this.store.remove([e.id]),this.updateRenderingBounds()}},undo:({deletedPage:e,deletedPageStates:t})=>{this.store.put([e]),this.store.put(t),this.updateRenderingBounds()}});duplicatePage(e,t=r.ez.createId()){if(this.getPages().length>=p.Et)return this;let i="string"==typeof e?e:e.id,s=this.getPage(i);if(!s)return this;let n={...this.getCamera()},h=this.getContentFromCurrentPage(this.getSortedChildIdsForParent(s.id));return this.batch(()=>{let e=this.getPages(),i=(0,a.eI)(s.index,e[e.indexOf(s)+1]?.index);if(this.createPage({name:s.name+" Copy",id:t,index:i}),this.setCurrentPage(t),this.setCamera(n),h)return this.putContentOntoCurrentPage(h)}),this}renamePage(e,t,i){let s="string"==typeof e?e:e.id;return this.getInstanceState().isReadonly||this.updatePage({id:s,name:t},i),this}_getAllAssetsQuery(){return this.store.query.records("asset")}getAssets(){return this._getAllAssetsQuery().get()}createAssets(e){return this._createAssets(e),this}_createAssets=this.history.createCommand("createAssets",e=>this.getInstanceState().isReadonly||e.length<=0?null:{data:{assets:e}},{do:({assets:e})=>{this.store.put(e)},undo:({assets:e})=>{this.store.remove(e.map(e=>e.id))}});updateAssets(e){return this._updateAssets(e),this}_updateAssets=this.history.createCommand("updateAssets",e=>{if(!this.getInstanceState().isReadonly&&!(e.length<=0))return{data:{snapshots:{},assets:e}}},{do:({assets:e,snapshots:t})=>{this.store.put(e.map(e=>{let i=this.store.get(e.id);return t[e.id]=i,{...i,...e}}))},undo:({snapshots:e})=>{this.store.put(Object.values(e))}});deleteAssets(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);return this._deleteAssets(t),this}_deleteAssets=this.history.createCommand("deleteAssets",e=>{if(this.getInstanceState().isReadonly||e.length<=0)return;let t=(0,a.oA)(e.map(e=>this.store.get(e)));return{data:{ids:e,prev:t}}},{do:({ids:e})=>{this.store.remove(e)},undo:({prev:e})=>{this.store.put(e)}});getAsset(e){return this.store.get("string"==typeof e?e:e.id)}_getShapeGeometryCache(){return this.store.createComputedCache("bounds",e=>this.getShapeUtil(e).getGeometry(e),(e,t)=>e.props===t.props)}getShapeGeometry(e){return this._getShapeGeometryCache().get("string"==typeof e?e:e.id)}_getShapeHandlesCache(){return this.store.createComputedCache("handles",e=>this.getShapeUtil(e).getHandles?.(e))}getShapeHandles(e){return this._getShapeHandlesCache().get("string"==typeof e?e:e.id)}getShapeLocalTransform(e){let t="string"==typeof e?e:e.id,i=this.getShape(t);if(!i)throw Error("Editor.getTransform: shape not found");return l._.Identity().translate(i.x,i.y).rotate(i.rotation)}_getShapePageTransformCache(){return this.store.createComputedCache("pageTransformCache",e=>{if((0,r.r5)(e.parentId))return this.getShapeLocalTransform(e);let t=this._getShapePageTransformCache().get(e.parentId)??l._.Identity();return l._.Compose(t,this.getShapeLocalTransform(e))})}getShapeParentTransform(e){let t="string"==typeof e?e:e.id,i=this.getShape(t);return!i||(0,r.r5)(i.parentId)?l._.Identity():this._getShapePageTransformCache().get(i.parentId)??l._.Identity()}getShapePageTransform(e){let t="string"==typeof e?e:this.getShape(e).id;return this._getShapePageTransformCache().get(t)??l._.Identity()}_getShapePageBoundsCache(){return this.store.createComputedCache("pageBoundsCache",e=>{let t=this._getShapePageTransformCache().get(e.id);if(!t)return new d.xu;let i=d.xu.FromPoints(l._.applyToPoints(t,this.getShapeGeometry(e).vertices));return i})}getShapePageBounds(e){return this._getShapePageBoundsCache().get("string"==typeof e?e:e.id)}_getShapeClipPathCache(){return this.store.createComputedCache("clipPathCache",e=>{let t=this._getShapeMaskCache().get(e.id);if(!t)return;if(0===t.length)return"polygon(0px 0px, 0px 0px, 0px 0px)";let i=this._getShapePageTransformCache().get(e.id);if(!i)return;let s=l._.applyToPoints(l._.Inverse(i),t);return`polygon(${s.map(e=>`${e.x}px ${e.y}px`).join(",")})`})}getShapeClipPath(e){return this._getShapeClipPathCache().get("string"==typeof e?e:e.id)}_getShapeMaskCache(){return this.store.createComputedCache("pageMaskCache",e=>{if((0,r.r5)(e.parentId))return;let t=this.getShapeAncestors(e.id).filter(e=>this.isShapeOfType(e,"frame"));if(0===t.length)return;let i=t.map(e=>this._getShapePageTransformCache().get(e.id).applyToPoints(this.getShapeGeometry(e).vertices)).reduce((e,t)=>{if(!(t&&e))return;let i=(0,S.tY)(e,t);return i?i.map(g.B.Cast):[]});return i})}getShapeMask(e){return this._getShapeMaskCache().get("string"==typeof e?e:e.id)}getShapeMaskedPageBounds(e){"string"!=typeof e&&(e=e.id);let t=this._getShapePageBoundsCache().get(e);if(!t)return;let i=this._getShapeMaskCache().get(e);if(i){if(0===i.length)return;let{corners:e}=t;if(e.every((e,t)=>e&&g.B.Equals(e,i[t])))return t.clone();let s=(0,S.tY)(i,e);if(!s)return;return d.xu.FromPoints(s)}return t}getShapeAncestors(e,t=[]){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return t;let a=s.parentId;if((0,r.r5)(a))return t.reverse(),t;let n=this.store.get(a);return n?(t.push(n),this.getShapeAncestors(n,t)):t}findShapeAncestor(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return;let a=s.parentId;if((0,r.r5)(a))return;let n=this.getShape(a);if(n)return t(n)?n:this.findShapeAncestor(n,t)}hasAncestor(e,t){let i="string"==typeof e?e:e?.id,s=i&&this.getShape(i);return!!s&&(s.parentId===t||this.hasAncestor(this.getShapeParent(s),t))}findCommonAncestor(e,t){if(0===e.length)return;let i="string"==typeof e[0]?e:e.map(e=>e.id),s=(0,a.oA)(i.map(e=>this.getShape(e)));if(1===s.length){let e=s[0].parentId;if((0,r.r5)(e))return;return t?this.findShapeAncestor(s[0],t)?.id:e}let[n,...h]=s,o=this.getShapeParent(n);for(;o;){if(t&&!t(o)){o=this.getShapeParent(o);continue}if(h.every(e=>this.hasAncestor(e,o.id)))return o.id;o=this.getShapeParent(o)}}isShapeOrAncestorLocked(e){let t="string"==typeof e?this.getShape(e):e;return void 0!==t&&(!!t.isLocked||this.isShapeOrAncestorLocked(this.getShapeParent(t)))}getCurrentPageBounds(){let e;return this.getCurrentPageShapeIds().forEach(t=>{let i=this.getShapeMaskedPageBounds(t);i&&(e=e?e.expand(i):i.clone())}),e}getSelectedShapeAtPoint(e){let t=this.getSelectedShapeIds();return this.getCurrentPageShapesSorted().filter(e=>"group"!==e.type&&t.includes(e.id)).reverse().find(t=>this.isPointInShape(t,e,{hitInside:!0,margin:0}))}getShapeAtPoint(e,t={}){let i=this.getZoomLevel(),s=this.getViewportPageBounds(),{filter:r,margin:a=0,hitLabels:n=!1,hitInside:h=!1,hitFrameInside:o=!1}=t,d=1/0,l=null,g=1/0,u=null,S=(t.renderingOnly?this.getCurrentPageRenderingShapesSorted():this.getCurrentPageShapesSorted()).filter(t=>{if(this.isShapeOfType(t,"group"))return!1;let i=this.getShapeMask(t);return(!i||!!(0,f.Of)(e,i))&&(!r||r(t))});for(let t=S.length-1;t>=0;t--){let r;let f=S[t],m=this.getShapeGeometry(f),y=m instanceof c.m,I=this.getPointInShapeSpace(f,e);if((this.isShapeOfType(f,"arrow")||this.isShapeOfType(f,"geo")&&"none"===f.props.fill)&&f.props.text.trim()){for(let e of m.children)if(e.isLabel&&e.isPointInBounds(I))return f}if(this.isShapeOfType(f,"frame")){let e=m.distanceToPoint(I,h);if(Math.abs(e)<=a)return u||f;if(m.hitTestPoint(I,0,!0))return u||l||(o?f:void 0);continue}if(y){let e=1/0;for(let t of m.children){if(t.isLabel&&!n)continue;let i=t.distanceToPoint(I,h);i<e&&(e=i)}r=e}else r=0===a&&(m.bounds.w<1||m.bounds.h<1)?m.distanceToPoint(I,h):m.bounds.containsPoint(I,a)?m.distanceToPoint(I,h):1/0;if(m.isClosed){if(r<=a){if(m.isFilled||y&&m.children[0].isFilled)return u||f;if(this.getShapePageBounds(f).contains(s))continue;if(Math.abs(r)<a)Math.abs(r)<g&&(g=Math.abs(r),u=f);else if(!u){let{area:e}=m;e<d&&(d=e,l=f)}}}else if(r<p.wM/i)return f}return u||l||void 0}getShapesAtPoint(e,t={}){return this.getCurrentPageShapes().filter(i=>this.isPointInShape(i,e,t))}isPointInShape(e,t,i={}){let{hitInside:s=!1,margin:r=0}=i,a="string"==typeof e?e:e.id,n=this.getShapeMask(a);return(!n||!!(0,f.Of)(t,n))&&this.getShapeGeometry(a).hitTestPoint(this.getPointInShapeSpace(e,t),r,s)}getPointInShapeSpace(e,t){let i="string"==typeof e?e:e.id;return this._getShapePageTransformCache().get(i).clone().invert().applyToPoint(t)}getPointInParentSpace(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return new g.B(0,0);if((0,r.r5)(s.parentId))return g.B.From(t);let a=this.getShapePageTransform(s.parentId);return a?a.clone().invert().applyToPoint(t):g.B.From(t)}getCurrentPageShapes(){return Array.from(this.getCurrentPageShapeIds(),e=>this.store.get(e))}getCurrentPageShapesSorted(){let e=new Set(this.getCurrentPageShapes().sort(a.hl)),t=[];function pushShapeWithDescendants(i){t.push(i),e.delete(i),e.forEach(e=>{e.parentId===i.id&&pushShapeWithDescendants(e)})}return e.forEach(e=>{let t=this.getShape(e.parentId);(0,r.VV)(t)||pushShapeWithDescendants(e)}),t}getCurrentPageRenderingShapesSorted(){return this.getRenderingShapes().filter(({isCulled:e})=>!e).sort((e,t)=>e.index-t.index).map(({shape:e})=>e)}isShapeOfType(e,t){let i="string"==typeof e?this.getShape(e):e;return i.type===t}getShape(e){let t="string"==typeof e?e:e.id;if((0,r.YT)(t))return this.store.get(t)}getShapeParent(e){let t="string"==typeof e?e:e?.id;if(!t)return;let i=this.getShape(t);if(void 0!==i&&(0,r.YT)(i.parentId))return this.store.get(i.parentId)}getShapeNearestSibling(e,t){if(!t)return;if(t.parentId===e.parentId)return t;let i=this.findShapeAncestor(t,t=>t.parentId===e.parentId);return i}isShapeInPage(e,t=this.getCurrentPageId()){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return!1;let r=!1;if(s.parentId===t)r=!0;else{let e=this.getShape(s.parentId);for(;e;){if(e.parentId===t){r=!0;break}e=this.getShape(e.parentId)}}return r}getAncestorPageId(e){let t="string"==typeof e?e:e?.id,i=t&&this.getShape(t);if(i)return(0,r.r5)(i.parentId)?i.parentId:this.getAncestorPageId(this.getShape(i.parentId))}_parentIdsToChildIds;reparentShapes(e,t,i){let s="string"==typeof e[0]?e:e.map(e=>e.id);if(0===s.length)return this;let n=[],h=(0,r.r5)(t)?l._.Identity():this.getShapePageTransform(t),o=h.rotation(),p=[],d=(0,a.oA)(this.getSortedChildIdsForParent(t).map(e=>this.getShape(e)));if(i){let e=d.find(e=>e.index===i);if(e){let t=d[d.indexOf(e)+1];p=t?(0,a.Xv)(i,t.index,s.length):(0,a.vw)(i,s.length)}else{let e=d.sort(a.hl).find(e=>e.index>i);p=e?(0,a.Xv)(i,e.index,s.length):(0,a.vw)(i,s.length)}}else{let e=d.length&&d[d.length-1];p=e?(0,a.vw)(e.index,s.length):(0,a.H$)(s.length)}let g=h.clone().invert(),u=(0,a.oA)(s.map(e=>this.getShape(e))),c=u.filter(e=>e.isLocked);c.length&&this.updateShapes(c.map(({id:e,type:t})=>({id:e,type:t,isLocked:!1})));for(let e=0;e<u.length;e++){let i=u[e],s=this.getShapePageTransform(i);if(!s)continue;let r=s.point();if(!r)continue;let a=g.applyToPoint(r),h=s.rotation()-o;n.push({id:i.id,type:i.type,parentId:t,x:a.x,y:a.y,rotation:h,index:p[e],isLocked:i.isLocked})}return this.updateShapes(n),this}getHighestIndexForParent(e){let t="string"==typeof e?e:e.id,i=this._parentIdsToChildIds.get()[t];if(!i||0===i.length)return"a1";let s=this.getShape(i[i.length-1]);return(0,a._L)(s.index)}_childIdsCache=new y._;getSortedChildIdsForParent(e){let t="string"==typeof e?e:e.id,i=this._parentIdsToChildIds.get()[t];return i?this._childIdsCache.get(i,()=>i):s.LZ}visitDescendants(e,t){let i="string"==typeof e?e:e.id,s=this.getSortedChildIdsForParent(i);for(let e of s)!1!==t(e)&&this.visitDescendants(e,t);return this}getShapeAndDescendantIds(e){let t=new Set,i=[...e];for(;i.length>0;){let e=i.pop();if(!e)break;if(!t.has(e))for(let s of(t.add(e),this.getSortedChildIdsForParent(e)))i.push(s)}return t}getDroppingOverShape(e,t=[]){let i=this.getCurrentPageShapesSorted();for(let s=i.length-1;s>=0;s--){let r=i[s];if(!this.getShapeUtil(r).canDropShapes(r,t)||t.find(e=>e.id===r.id||this.hasAncestor(r,e.id)))continue;let a=this.getShapeMaskedPageBounds(r.id);if(a&&a.containsPoint(e)&&this.getShapeGeometry(r).hitTestPoint(this.getPointInShapeSpace(r,e),0,!0))return r}}getOutermostSelectableShape(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i),r=s,a=s,n=this.getFocusedGroup();for(;a;){if(this.isShapeOfType(a,"group")&&n?.id!==a.id&&!this.hasAncestor(n,a.id)&&(t?.(a)??!0))r=a;else if(n?.id===a.id)break;a=this.getShapeParent(a)}return r}rotateShapesBy(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(i.length<=0)return this;let s=(0,_.o)({editor:this});return s&&(0,_.Z)({delta:t,snapshot:s,editor:this,stage:"one-off"}),this}getChangesToTranslateShape(e,t){let i=e,s=this.getShapeUtil(e);return i=applyPartialToShape(i,s.onTranslateStart?.(i)??void 0),i=applyPartialToShape(i,{id:e.id,type:e.type,x:t.x,y:t.y}),i=applyPartialToShape(i,s.onTranslate?.(e,i)??void 0),i=applyPartialToShape(i,s.onTranslateEnd?.(e,i)??void 0)}nudgeShapes(e,t,i){let s="string"==typeof e[0]?e:e.map(e=>e.id);if(s.length<=0)return this;let r=[];for(let e of s){let i=this.getShape(e),s=g.B.From(t),a=this.getShapeParentTransform(i);a&&s.rot(-a.rotation()),r.push(this.getChangesToTranslateShape(i,s.add(i)))}return this.updateShapes(r,{squashing:!0,...i}),this}duplicateShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(i.length<=0)return this;let s=new Set(i),n=[],h=[...i];for(;h.length>0;){let e=h.pop();if(!e)break;n.push(e),this.getSortedChildIdsForParent(e).forEach(e=>h.push(e))}n.reverse();let o=new Map(n.map(e=>[e,(0,r.F1)()])),d=(0,a.oA)(n.map(e=>{let i=this.getShape(e);if(!i)return null;let r=o.get(e),n=0,h=0;if(t&&s.has(e)){let e=this.getShapeParentTransform(i),s=new g.B(t.x,t.y).rot(-e.rotation());n=s.x,h=s.y}let p=i.parentId??this.getCurrentPageId(),d=this.getSortedChildIdsForParent(p),l=d.indexOf(i.id),u=d[l+1],c=u?this.getShape(u):null,S=c?(0,a.eI)(i.index,c.index):(0,a._L)(i.index),f=(0,a.p$)(i);if(this.isShapeOfType(i,"arrow")&&this.isShapeOfType(f,"arrow")){let e,t;let s=this.getArrowInfo(i);if("binding"===i.props.start.type&&!(e=o.get(i.props.start.boundShapeId))){if(s?.isValid){let{x:e,y:t}=s.start.point;f.props.start={type:"point",x:e,y:t}}else{let{start:e}=(0,U.Qs)(this,i);f.props.start={type:"point",x:e.x,y:e.y}}}if("binding"===i.props.end.type&&!(t=o.get(i.props.end.boundShapeId))){if(s?.isValid){let{x:e,y:t}=s.end.point;f.props.end={type:"point",x:e,y:t}}else{let{end:e}=(0,U.Qs)(this,i);f.props.start={type:"point",x:e.x,y:e.y}}}let r=(0,U.el)(f)?(0,K.r)(this,f):(0,z.p)(this,f);if(s?.isValid&&r?.isValid&&!(0,U.el)(i)){let e=g.B.Med(s.start.handle,s.end.handle),t=g.B.Dist(s.middle,e),i=g.B.Dist(r.middle,e);f.props.bend<0?f.props.bend+=i-t:f.props.bend-=i-t}"binding"===f.props.start.type&&e&&(f.props.start.boundShapeId=e),"binding"===f.props.end.type&&t&&(f.props.end.boundShapeId=t)}return{...f,id:r,x:i.x+n,y:i.y+h,index:S}}));return d.forEach(e=>{(0,r.YT)(e.parentId)&&o.has(e.parentId)&&(e.parentId=o.get(e.parentId))}),this.history.batch(()=>{let e=d.length+this.getCurrentPageShapeIds().size>p.kx;e&&alertMaxShapes(this);let i=e?d.slice(0,p.kx-this.getCurrentPageShapeIds().size):d,s=i.map(e=>e.id);if(this.createShapes(i),this.setSelectedShapes(s),void 0!==t){let e=this.getSelectionPageBounds(),t=this.getViewportPageBounds();e&&!t.contains(e)&&this.centerOnPoint(e.center,{duration:p.KD})}}),this}moveShapesToPage(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(0===i.length||this.getInstanceState().isReadonly)return this;let s=this.getCurrentPageId();if(t===s||!this.store.has(t))return this;let r=this.getContentFromCurrentPage(i);if(!r)return this;if(this.getPageShapeIds(t).size+r.shapes.length>p.kx)return alertMaxShapes(this,t),this;let a=this.getCamera().z;return this.history.batch(()=>{this.deleteShapes(i),this.setCurrentPage(t),this.setFocusedGroup(null),this.selectNone(),this.putContentOntoCurrentPage(r,{select:!0,preserveIds:!0,preservePosition:!0}),this.setCamera({...this.getCamera(),z:a}),this.centerOnPoint(this.getSelectionRotatedPageBounds().center)}),this}toggleLock(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly||0===t.length)return this;let i=!0,s=!0,r=[];for(let e of t){let t=this.getShape(e);t&&(r.push(t),t.isLocked?s=!1:i=!1)}return this.batch(()=>{s?(this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!0}))),this.setSelectedShapes([])):i?this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!1}))):this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!0})))}),this}sendToBack(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,C.B)(this,"toBack",t);return i&&this.updateShapes(i),this}sendBackward(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,C.B)(this,"backward",t);return i&&this.updateShapes(i),this}bringForward(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,C.B)(this,"forward",t);return i&&this.updateShapes(i),this}bringToFront(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,C.B)(this,"toFront",t);return i&&this.updateShapes(i),this}flipShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly)return this;let s=(0,a.oA)(i.map(e=>this.getShape(e)));if(!s.length)return this;s=(0,a.oA)(s.map(e=>this.isShapeOfType(e,"group")?this.getSortedChildIdsForParent(e.id).map(e=>this.getShape(e)):e).flat());let r=d.xu.Common((0,a.oA)(s.map(e=>this.getShapePageBounds(e)))).center;return this.batch(()=>{for(let e of s){let i=this.getShapeGeometry(e).bounds,s=this.getShapePageTransform(e.id);s&&this.resizeShape(e.id,{x:"horizontal"===t?-1:1,y:"vertical"===t?-1:1},{initialBounds:i,initialPageTransform:s,initialShape:e,mode:"scale_shape",scaleOrigin:r,scaleAxisRotation:0})}}),this}stackShapes(e,t,i){let s,r,n,h,o;let p="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly)return this;let d=(0,a.oA)(p.map(e=>this.getShape(e)).filter(e=>!(!e||this.isShapeOfType(e,"arrow")&&("binding"===e.props.start.type||"binding"===e.props.end.type)))),l=d.length;if(0===i&&l<3||l<2)return this;let u=Object.fromEntries(d.map(e=>[e.id,this.getShapePageBounds(e)]));if("horizontal"===t?(s="x",r="minX",n="maxX",h="width"):(s="y",r="minY",n="maxY",h="height"),0===i){let e=[];d.sort((e,t)=>u[e.id][r]-u[t.id][r]);for(let t=0;t<l-1;t++){let i=d[t],s=d[t+1],a=u[i.id],h=u[s.id],o=h[r]-a[n],p=e.find(e=>e.gap===o);p?p.count++:e.push({gap:o,count:1})}let t=0;e.forEach(e=>{e.count>t&&(t=e.count,o=e.gap)}),1===t&&(o=Math.max(0,e.reduce((e,t)=>e+t.gap*t.count,0)/(l-1)))}else o=i;let c=[],S=u[d[0].id][n];return d.forEach((e,t)=>{if(0===t)return;let i={x:0,y:0};i[s]=S+o-u[e.id][s];let r=this.getShapeParent(e),a=r?g.B.Rot(i,-this.getShapePageTransform(r).decompose().rotation):i,n=this.getShapeUtil(e).onTranslateStart?.(e);c.push(n?{...n,[s]:e[s]+a[s]}:{id:e.id,type:e.type,[s]:e[s]+a[s]}),S+=u[e.id][h]+o}),this.updateShapes(c),this}packShapes(e,t){let i,s,r;let n="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly||n.length<2)return this;let h=(0,a.oA)(n.map(e=>this.getShape(e)).filter(e=>!(!e||this.isShapeOfType(e,"arrow")&&("binding"===e.props.start.type||"binding"===e.props.end.type)))),o={},p={},l,u,c=0;for(let e=0;e<h.length;e++)l=h[e],u=this.getShapePageBounds(l),o[l.id]=u,p[l.id]=u.clone(),c+=u.width*u.height;let S=d.xu.Common((0,a.oA)(Object.values(o))),f=S.width;h.sort((e,t)=>o[t.id].height-o[e.id].height);let m=Math.max(Math.ceil(Math.sqrt(c/.95)),f),y=[new d.xu(S.x,S.y,m,1/0)],I=0,P=0;for(let e=0;e<h.length;e++){u=p[(l=h[e]).id];for(let e=y.length-1;e>=0;e--)if(i=y[e],!(u.width>i.width)&&!(u.height>i.height)){u.x=i.x,u.y=i.y,P=Math.max(P,u.maxY),I=Math.max(I,u.maxX),u.width===i.width&&u.height===i.height?(s=y.pop(),e<y.length&&(y[e]=s)):u.height===i.height?(i.x+=u.width+t,i.width-=u.width+t):(u.width===i.width||y.push(new d.xu(i.x+(u.width+t),i.y,i.width-(u.width+t),u.height)),i.y+=u.height+t,i.height-=u.height+t);break}}let C=d.xu.Common(Object.values(p)),_=g.B.Sub(S.center,C.center),w=[];for(let e=0;e<h.length;e++){u=o[(l=h[e]).id],r=p[l.id];let t=g.B.Sub(r.point,u.point).add(_),i=this.getShapeParentTransform(l);i&&t.rot(-i.rotation());let s={id:l.id,type:l.type,x:l.x+t.x,y:l.y+t.y},a=this.getShapeUtil(l).onTranslateStart?.({...l,...s});a?w.push({...s,...a}):w.push(s)}return w.length&&this.updateShapes(w),this}alignShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly||i.length<2)return this;let s=(0,a.oA)(i.map(e=>this.getShape(e))),r=Object.fromEntries(s.map(e=>[e.id,this.getShapePageBounds(e)])),n=d.xu.Common((0,a.oA)(Object.values(r))),h=[];return s.forEach(e=>{let i=r[e.id];if(!i)return;let s={x:0,y:0};switch(t){case"top":s.y=n.minY-i.minY;break;case"center-vertical":s.y=n.midY-i.minY-i.height/2;break;case"bottom":s.y=n.maxY-i.minY-i.height;break;case"left":s.x=n.minX-i.minX;break;case"center-horizontal":s.x=n.midX-i.minX-i.width/2;break;case"right":s.x=n.maxX-i.minX-i.width}let a=this.getShapeParent(e),o=a?g.B.Rot(s,-this.getShapePageTransform(a).decompose().rotation):s;h.push(this.getChangesToTranslateShape(e,g.B.Add(e,o)))}),this.updateShapes(h),this}distributeShapes(e,t){let i,s,r,n,h;let o="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly||o.length<3)return this;let p=o.length,d=(0,a.oA)(o.map(e=>this.getShape(e))),l=Object.fromEntries(d.map(e=>[e.id,this.getShapePageBounds(e)]));"horizontal"===t?(i="x",s="minX",r="maxX",n="midX",h="width"):(i="y",s="minY",r="maxY",n="midY",h="height");let u=[],c=d.sort((e,t)=>l[e.id][s]-l[t.id][s])[0],S=d.sort((e,t)=>l[t.id][r]-l[e.id][r])[0],f=l[c.id][n],m=(l[S.id][n]-f)/(p-1),y=f+m;return d.filter(e=>e!==c&&e!==S).sort((e,t)=>l[e.id][n]-l[t.id][n]).forEach((e,t)=>{let s={x:0,y:0};s[i]=y+m*t-l[e.id][h]/2-l[e.id][i];let r=this.getShapeParent(e),a=r?g.B.Rot(s,-this.getShapePageTransform(r).rotation()):s;u.push(this.getChangesToTranslateShape(e,g.B.Add(e,a)))}),this.updateShapes(u),this}stretchShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly||i.length<2)return this;let s=(0,a.oA)(i.map(e=>this.getShape(e))),r=Object.fromEntries(i.map(e=>[e,this.getShapeGeometry(e).bounds])),n=Object.fromEntries(i.map(e=>[e,this.getShapePageBounds(e)])),h=d.xu.Common((0,a.oA)(Object.values(n)));switch(t){case"vertical":this.batch(()=>{for(let e of s){let t=this.getShapePageTransform(e).rotation();if(t%f.yo)continue;let i=r[e.id],s=n[e.id],a=new g.B(0,h.minY-s.minY),o=this.getShapeParentTransform(e);o&&a.rot(-o.rotation());let{x:p,y:d}=g.B.Add(a,e);this.updateShapes([{id:e.id,type:e.type,x:p,y:d}],{squashing:!0});let l=new g.B(1,h.height/s.height);this.resizeShape(e.id,l,{initialBounds:i,scaleOrigin:new g.B(s.center.x,h.minY),scaleAxisRotation:0})}});break;case"horizontal":this.batch(()=>{for(let e of s){let t=r[e.id],i=n[e.id],s=this.getShapePageTransform(e).rotation();if(s%f.yo)continue;let a=new g.B(h.minX-i.minX,0),o=this.getShapeParentTransform(e);o&&a.rot(-o.rotation());let{x:p,y:d}=g.B.Add(a,e);this.updateShapes([{id:e.id,type:e.type,x:p,y:d}],{squashing:!0});let l=new g.B(h.width/i.width,1);this.resizeShape(e.id,l,{initialBounds:t,scaleOrigin:new g.B(h.minX,i.center.y),scaleAxisRotation:0})}})}return this}resizeShape(e,t,i={}){let s="string"==typeof e?e:e.id;if(this.getInstanceState().isReadonly)return this;Number.isFinite(t.x)||(t=new g.B(1,t.y)),Number.isFinite(t.y)||(t=new g.B(t.x,1));let r=i.initialShape??this.getShape(s);if(!r)return this;let a=i.scaleOrigin??this.getShapePageBounds(s)?.center;if(!a)return this;let n=i.initialPageTransform?l._.Cast(i.initialPageTransform):this.getShapePageTransform(s);if(!n)return this;let h=n.rotation();if(null==h)return this;let o=i.scaleAxisRotation??h,p=i.initialBounds??this.getShapeGeometry(s).bounds;if(!p)return this;if(!(0,f._G)(h,o))return this._resizeUnalignedShape(s,t,{...i,initialBounds:p,scaleOrigin:a,scaleAxisRotation:o,initialPageTransform:n,initialShape:r});let d=this.getShapeUtil(r);if(d.isAspectRatioLocked(r)&&(t=Math.abs(t.x)>Math.abs(t.y)?new g.B(t.x,Math.sign(t.y)*Math.abs(t.x)):new g.B(Math.sign(t.x)*Math.abs(t.y),t.y)),d.onResize&&d.canResize(r)){let e=this._scalePagePoint(l._.applyToPoint(n,new g.B(0,0)),a,t,o),u=this.getPointInParentSpace(r.id,e),c=new g.B(t.x,t.y),S=(0,f.C2)((h-o)%Math.PI,0);c.x=S?t.x:t.y,c.y=S?t.y:t.x;let m=l._.applyToPoint(n,new g.B),{x:y,y:I}=this.getPointInParentSpace(r.id,m);this.updateShapes([{id:s,type:r.type,x:u.x,y:u.y,...d.onResize({...r,x:y,y:I},{newPoint:u,handle:i.dragHandle??"bottom_right",mode:i.mode??"scale_shape",scaleX:c.x,scaleY:c.y,initialBounds:p,initialShape:r})}],{squashing:!0})}else{let e=l._.applyToPoint(n,p.center),i=this._scalePagePoint(e,a,t,o),h=this.getPointInParentSpace(r.id,e),d=this.getPointInParentSpace(r.id,i),u=g.B.Sub(d,h);this.updateShapes([{id:s,type:r.type,x:r.x+u.x,y:r.y+u.y}],{squashing:!0})}return this}_scalePagePoint(e,t,i,s){let r=g.B.RotWith(e,t,-s).sub(t),a=g.B.MulV(r,i),n=g.B.Add(a,t).rotWith(t,s);return n}_resizeUnalignedShape(e,t,i){let{type:s}=i.initialShape,r=new g.B(t.x,t.y);if(Math.abs(t.x)>Math.abs(t.y)?r.x=Math.sign(t.x)*Math.abs(t.y):r.y=Math.sign(t.y)*Math.abs(t.x),this.resizeShape(e,r,{initialShape:i.initialShape,initialBounds:i.initialBounds}),Math.sign(t.x)*Math.sign(t.y)<0){let{rotation:t}=l._.Decompose(i.initialPageTransform);t-=2*t,this.updateShapes([{id:e,type:s,rotation:t}],{squashing:!0})}let a=l._.applyToPoint(i.initialPageTransform,i.initialBounds.center),n=this._scalePagePoint(a,i.scaleOrigin,t,i.scaleAxisRotation),h=this.getShapePageBounds(e),o=this.getShapePageTransform(e),p=h.center,d=o.point();if(!p||!d)return this;let u=g.B.Sub(n,p),c=g.B.Add(d,u),{x:S,y:f}=this.getPointInParentSpace(e,c);return this.updateShapes([{id:e,type:s,x:S,y:f}],{squashing:!0}),this}getInitialMetaForShape(e){return{}}createShape(e){return this._createShapes([e]),this}createShapes(e){if(!Array.isArray(e))throw Error("Editor.createShapes: must provide an array of shapes or shape partials");return this._createShapes(e),this}_createShapes=this.history.createCommand("createShapes",e=>{if(this.getInstanceState().isReadonly||e.length<=0)return null;let t=this.getCurrentPageShapeIds(),i=e.length+t.size>p.kx;if(i){alertMaxShapes(this);return}return 0===e.length?null:{data:{currentPageId:this.getCurrentPageId(),partials:e.map(e=>e.id?e:{...e,id:(0,r.F1)()})}}},{do:({partials:e})=>{let t=this.getFocusedGroupId(),i=this.getCurrentPageShapesSorted();e=e.map(s=>{if(!s.parentId||!(this.store.has(s.parentId)||e.some(e=>e.id===s.parentId))){let e=this.getFocusedGroupId();for(let t=i.length-1;t>=0;t--){let r=i[t];if(this.getShapeUtil(r).canReceiveNewChildrenOfType(r,s.type)&&this.isPointInShape(r,{x:s.x??0,y:s.y??0},{margin:0,hitInside:!0})){e=r.id;break}}let a=s.parentId;if(e===s.id&&(e=t),e!==a&&((s={...s}).parentId=e,(0,r.YT)(e))){let t=this.getPointInShapeSpace(this.getShape(e),{x:s.x??0,y:s.y??0});s.x=t.x,s.y=t.y,s.rotation=-this.getShapePageTransform(e).rotation()+(s.rotation??0)}}return s});let s=new Map,n=[];for(let i of e){let e=this.getShapeUtil(i),r=i.index;if(!r){let e=i.parentId??t;s.has(e)||s.set(e,this.getHighestIndexForParent(e)),r=s.get(e),s.set(e,(0,a._L)(r))}let h=e.getDefaultProps();for(let[e,t]of this.styleProps[i.type])h[t]=this.getStyleForNextShape(e);let o=this.store.schema.types.shape.create({...i,index:r,opacity:i.opacity??this.getInstanceState().opacityForNextShape,parentId:i.parentId??t,props:"props"in i?{...h,...i.props}:h});if(void 0===o.index)throw Error("no index!");let p=this.getShapeUtil(o).onBeforeCreate?.(o);p&&(o=p),n.push(o)}n.forEach(e=>{e.meta={...this.getInitialMetaForShape(e),...e.meta}}),this.store.put(n)},undo:({partials:e})=>{this.store.remove(e.map(e=>e.id))}});animatingShapes=new Map;animateShape(e,t){return this.animateShapes([e],t)}animateShapes(e,t={}){let i,s,r,a;let{duration:n=500,easing:h=u.L.linear}=t,o=(0,w.E)(),p=n,d=[];for(let t=0,i=e.length;t<i;t++){if(!(s=e[t]))continue;r={partial:s,values:[]};let i=this.getShape(s.id);if(i){for(let e of["x","y","rotation"])void 0!==s[e]&&i[e]!==s[e]&&r.values.push({prop:e,from:i[e],to:s[e]});d.push(r),this.animatingShapes.set(i.id,o)}}let handleTick=t=>{if((p-=t)<0){let{animatingShapes:t}=this,i=e.filter(e=>e&&t.get(e.id)===o);i.length&&this.updateShapes(i,{squashing:!1}),this.removeListener("tick",handleTick);return}i=h(1-p/n);let{animatingShapes:s}=this,r=[];for(let e=0,t=d.length;e<t;e++)a=d[e],s.get(a.partial.id)===o&&r.push({id:a.partial.id,type:a.partial.type,...a.values.reduce((e,{prop:t,from:s,to:r})=>(e[t]=s+(r-s)*i,e),{})});this._updateShapes(r,{squashing:!0})};return this.addListener("tick",handleTick),this}groupShapes(e,t=(0,r.F1)()){if(!Array.isArray(e))throw Error("Editor.groupShapes: must provide an array of shapes or shape ids");if(this.getInstanceState().isReadonly)return this;let i="string"==typeof e[0]?e:e.map(e=>e.id);if(i.length<=1)return this;let s=(0,a.oA)(this._getUnlockedShapeIds(i).map(e=>this.getShape(e))),n=s.sort(a.hl).map(e=>e.id),h=d.xu.Common((0,a.oA)(s.map(e=>this.getShapePageBounds(e)))),{x:o,y:p}=h.point,l=this.findCommonAncestor(s)??this.getCurrentPageId();if("select"!==this.getCurrentToolId())return this;this.isIn("select.idle")||this.cancel();let g=s.filter(e=>e.parentId===l).sort(a.hl),u=g[g.length-1]?.index;return this.batch(()=>{this.createShapes([{id:t,type:"group",parentId:l,index:u,x:o,y:p,opacity:1,props:{}}]),this.reparentShapes(n,t),this.select(t)}),this}ungroupShapes(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly||0===t.length||"select"!==this.getCurrentToolId())return this;this.isIn("select.idle")||this.cancel();let i=new Set,s=(0,a.oA)(t.map(e=>this.getShape(e))),r=[];return s.forEach(e=>{this.isShapeOfType(e,"group")?r.push(e):i.add(e.id)}),0===r.length||this.batch(()=>{let e;for(let t=0,s=r.length;t<s;t++){e=r[t];let s=this.getSortedChildIdsForParent(e.id);for(let e=0,t=s.length;e<t;e++)i.add(s[e]);this.reparentShapes(s,e.parentId,e.index)}this.deleteShapes(r.map(e=>e.id)),this.select(...i)}),this}updateShape(e,t){return this.updateShapes([e],t),this}updateShapes(e,t){let i=Array(e.length);for(let t=0,s=e.length;t<s;t++){let s=e[t];if(!s)continue;let r=this.getShape(s.id);r&&(!this.isShapeOrAncestorLocked(r)||Object.hasOwn(s,"isLocked"))&&(this.animatingShapes.delete(s.id),i.push(s))}return this._updateShapes(i,t),this}_updateShapes=this.history.createCommand("updateShapes",(e,t)=>{let i,s;if(this.getInstanceState().isReadonly)return null;let r={},a={};for(let t=0,n=e.length;t<n;t++){let n=e[t];n&&(i=this.getShape(n.id))&&(s=applyPartialToShape(i,n))!==i&&(r[i.id]=i,a[i.id]=s)}return{data:{snapshots:r,updates:a},...t}},{do:({updates:e})=>{this.store.put((0,a.UM)(e).map(e=>{let t=this.store.get(e.id);if(t){let i=this.getShapeUtil(e).onBeforeUpdate?.(t,e);if(i)return i}return e}))},undo:({snapshots:e})=>{this.store.put(Object.values(e))},squash:(e,t)=>({snapshots:{...t.snapshots,...e.snapshots},updates:{...e.updates,...t.updates}})});_getUnlockedShapeIds(e){return e.filter(e=>!this.getShape(e)?.isLocked)}deleteShapes(e){if(!Array.isArray(e))throw Error("Editor.deleteShapes: must provide an array of shapes or shapeIds");return this._deleteShapes(this._getUnlockedShapeIds("string"==typeof e[0]?e:e.map(e=>e.id))),this}deleteShape(e){return this.deleteShapes(["string"==typeof e?e:e.id]),this}_deleteShapes=this.history.createCommand("delete_shapes",e=>{if(this.getInstanceState().isReadonly||0===e.length)return null;let t=[...this.getCurrentPageState().selectedShapeIds],i=new Set(e);for(let t of e)this.visitDescendants(t,e=>{i.add(e)});let s=[...i],r=this._getArrowBindingsIndex().get(),n=(0,a.oA)(s.flatMap(e=>{let t=this.getShape(e),i=r[e];return i&&i.length>0?i.map(({arrowId:e})=>this.getShape(e)).concat(t):t})),h=t.filter(e=>!i.has(e));return{data:{deletedIds:s,snapshots:n,prevSelectedShapeIds:t,postSelectedShapeIds:h}}},{do:({deletedIds:e,postSelectedShapeIds:t})=>{this.store.remove(e),this.store.update(this.getCurrentPageState().id,e=>({...e,selectedShapeIds:t}))},undo:({snapshots:e,prevSelectedShapeIds:t})=>{this.store.put(e),this.store.update(this.getCurrentPageState().id,e=>({...e,selectedShapeIds:t}))}});_extractSharedStyles(e,t){if(this.isShapeOfType(e,"group")){let i=this._parentIdsToChildIds.get()[e.id];if(i)for(let e=0,s=i.length;e<s;e++)this._extractSharedStyles(this.getShape(i[e]),t)}else for(let[i,s]of this.styleProps[e.type])t.applyValue(i,(0,a.eg)(e.props,s))}_getSelectionSharedStyles(){let e=this.getSelectedShapes(),t=new m.o;for(let i of e)this._extractSharedStyles(i,t);return t}getStyleForNextShape(e){let t=this.getInstanceState().stylesForNextShape[e.id];return void 0===t?e.defaultValue:t}getShapeStyleIfExists(e,t){let i=this.styleProps[e.type].get(t);if(void 0!==i)return(0,a.eg)(e.props,i)}getSharedStyles(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0)return this._getSelectionSharedStyles();let e=this.root.getCurrent(),t=new m.o;if(!e)return t;if(e.shapeType)for(let i of this.styleProps[e.shapeType].keys())t.applyValue(i,this.getStyleForNextShape(i));return t}getSharedOpacity(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0){let e=[],addShape=t=>{let i=this.getShape(t);if(i){if(this.isShapeOfType(i,"group"))for(let e of this.getSortedChildIdsForParent(i.id))addShape(e);else e.push(i)}};for(let e of this.getSelectedShapeIds())addShape(e);let t=null;for(let i of e)if(null===t)t=i.opacity;else if(t!==i.opacity)return{type:"mixed"};if(null!==t)return{type:"shared",value:t}}return{type:"shared",value:this.getInstanceState().opacityForNextShape}}setOpacityForNextShapes(e,t){return this.updateInstanceState({opacityForNextShape:e},t),this}setOpacityForSelectedShapes(e,t){let i=this.getSelectedShapes();if(i.length>0){let s=[],addShapeById=e=>{if(this.isShapeOfType(e,"group")){let t=this.getSortedChildIdsForParent(e);for(let e of t)addShapeById(this.getShape(e))}else s.push(e)};for(let e of i)addShapeById(e);this.updateShapes(s.map(t=>({id:t.id,type:t.type,opacity:e})),t)}return this}setStyleForNextShapes(e,t,i){let s=this.getInstanceState().stylesForNextShape;return this.updateInstanceState({stylesForNextShape:{...s,[e.id]:t}},i),this}setStyleForSelectedShapes(e,t,i){let s=this.getSelectedShapes();if(s.length>0){let r=[],addShapeById=i=>{if(this.isShapeOfType(i,"group")){let e=this.getSortedChildIdsForParent(i.id);for(let t of e)addShapeById(this.getShape(t))}else{let s=this.getShapeUtil(i),a=this.styleProps[i.type].get(e);if(a){let e={id:i.id,type:i.type,props:{[a]:t}};r.push({util:s,originalShape:i,updatePartial:e})}}};for(let e of s)addShapeById(e);this.updateShapes(r.map(({updatePartial:e})=>e),i)}return this}externalAssetContentHandlers={file:null,url:null};registerExternalAssetHandler(e,t){return this.externalAssetContentHandlers[e]=t,this}async getAssetForExternalContent(e){return await this.externalAssetContentHandlers[e.type]?.(e)}externalContentHandlers={text:null,files:null,embed:null,"svg-text":null,url:null};registerExternalContentHandler(e,t){return this.externalContentHandlers[e]=t,this}async putExternalContent(e){return this.externalContentHandlers[e.type]?.(e)}getContentFromCurrentPage(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);if(!t||0===t.length)return;let i={},s=(0,a.D8)(t.map(e=>this.getShape(e)).sort(a.hl).flatMap(e=>{let t=[e];return this.visitDescendants(e.id,e=>{t.push(this.getShape(e))}),t}));s=s.map(e=>{if(i[e.id]=this.getShapePageTransform(e.id),e=(0,a.v4)(e),this.isShapeOfType(e,"arrow")){let t="binding"===e.props.start.type?e.props.start.boundShapeId:void 0,i="binding"===e.props.end.type?e.props.end.boundShapeId:void 0,r=this.getArrowInfo(e);if("binding"===e.props.start.type&&!s.some(e=>e.id===t)){if(r?.isValid){let{x:t,y:i}=r.start.point;e.props.start={type:"point",x:t,y:i}}else{let{start:t}=(0,U.Qs)(this,e);e.props.start={type:"point",x:t.x,y:t.y}}}if("binding"===e.props.end.type&&!s.some(e=>e.id===i)){if(r?.isValid){let{x:t,y:i}=r.end.point;e.props.end={type:"point",x:t,y:i}}else{let{end:t}=(0,U.Qs)(this,e);e.props.end={type:"point",x:t.x,y:t.y}}}let a=(0,U.el)(e)?(0,K.r)(this,e):(0,z.p)(this,e);if(r?.isValid&&a?.isValid&&!(0,U.el)(e)){let t=g.B.Med(r.start.handle,r.end.handle),i=g.B.Dist(r.middle,t),s=g.B.Dist(a.middle,t);e.props.bend<0?e.props.bend+=s-i:e.props.bend-=s-i}}return e});let r=[];s.forEach(e=>{if(void 0===s.find(t=>t.id===e.parentId)){let t=this.getShapePageTransform(e.id),i=t.point(),s=t.rotation();e.x=i.x,e.y=i.y,e.rotation=s,e.parentId=this.getCurrentPageId(),r.push(e.id)}});let n=new Set;return s.forEach(e=>{"assetId"in e.props&&null!==e.props.assetId&&n.add(e.props.assetId)}),{shapes:s,rootShapeIds:r,schema:this.store.schema.serialize(),assets:(0,a.oA)(Array.from(n).map(e=>this.getAsset(e)))}}putContentOntoCurrentPage(e,t={}){if(this.getInstanceState().isReadonly)return this;if(!e.schema)throw Error("Could not put content:\ncontent is missing a schema.");let{select:i=!1,preserveIds:s=!1,preservePosition:n=!1}=t,{point:h}=t,o=this.getCurrentPageId(),{rootShapeIds:u}=e,c=[],S=[],f={store:{...Object.fromEntries(e.assets.map(e=>[e.id,e])),...Object.fromEntries(e.shapes.map(e=>[e.id,e]))},schema:e.schema},m=this.store.schema.migrateStoreSnapshot(f);if("error"===m.type)throw Error("Could not put content: could not migrate content");for(let e of Object.values(m.value))switch(e.typeName){case"asset":c.push(e);break;case"shape":S.push(e)}let y=new Map(S.map(e=>[e.id,(0,r.F1)()])),P=this.getCurrentPageId(),C=1/0,_=[];for(let e of this.getSelectedShapes()){if(0===C)break;let t=this.isShapeOfType(e,"frame"),i=this.getShapeAncestors(e);t&&i.push(e);let s=t?i.length+1:i.length;if(s<C)C=s,_=i,P=t?e.id:e.parentId;else if(s===C){if(_.length!==i.length)throw Error(`Ancestors: ${_.length} !== ${i.length}`);if(0===_.length){P=o;break}P=o;for(let e=0;e<_.length&&i[e]===_[e];e++)P=i[e].id}}let w=!1;if(!(0,r.r5)(P)){let e=this.getShape(P);if(e){if(this.getViewportPageBounds().includes(this.getShapePageBounds(e))){if(1===u.length){let t=S.find(e=>e.id===u[0]);this.isShapeOfType(e,"frame")&&this.isShapeOfType(t,"frame")&&t.props.w===e?.props.w&&t.props.h===e?.props.h&&(w=!0)}}else P=o}else P=o}w||(w=y.has(P)),w&&(P=this.getShape(P).parentId);let x=this.getHighestIndexForParent(P),b=[],T=S.map(e=>{let t;if(s)t=(0,a.p$)(e),y.set(e.id,e.id);else{let i=y.get(e.id);t=(0,a.p$)({...e,id:i})}if(u.includes(e.id)&&(t.parentId=o,b.push(t)),y.has(t.parentId)?t.parentId=y.get(e.parentId):(u.push(t.id),t.index=x,x=(0,a._L)(x)),this.isShapeOfType(t,"arrow")){if("binding"===t.props.start.type){let e=y.get(t.props.start.boundShapeId);t.props.start=e?{...t.props.start,boundShapeId:e}:{type:"point",x:0,y:0}}if("binding"===t.props.end.type){let e=y.get(t.props.end.boundShapeId);t.props.end=e?{...t.props.end,boundShapeId:e}:{type:"point",x:0,y:0}}}return t});if(T.length+this.getCurrentPageShapeIds().size>p.kx)return alertMaxShapes(this),this;let v=[],A=[];return v=c.filter(e=>!this.store.has(e.id)).map(e=>(("image"===e.type||"video"===e.type)&&(e.props.src&&e.props.src?.startsWith("data:image")?(A.push((0,a.v4)(e)),e.props.src=null):A.push((0,a.v4)(e))),e)),Promise.allSettled(A.map(async e=>{let t=await (0,I.B)(e.props.src,e.props.name,e.props.mimeType??"image/png"),i=await this.getAssetForExternalContent({type:"file",file:t});return i?[e,i]:null})).then(e=>{this.updateAssets((0,a.oA)(e.map(e=>"fulfilled"===e.status&&e.value?{...e.value[1],id:e.value[0].id}:void 0)))}),this.batch(()=>{v.length>0&&this.createAssets(v),this.createShapes(T),i&&this.select(...b.map(e=>e.id)),P!==o&&this.reparentShapes(b.map(e=>e.id),P);let e=T.map(e=>this.getShape(e.id)),t=d.xu.Common(e.map(e=>this.getShapePageBounds(e)));if(void 0===h){if((0,r.r5)(P)){let e=this.getViewportPageBounds();h=n||e.includes(d.xu.From(t))?t.center:e.center}else{let e=this.getShape(P);h=l._.applyToPoint(this.getShapePageTransform(e),this.getShapeGeometry(e).bounds.center)}}if(1===b.length){let e=b[0];if(this.isShapeOfType(e,"frame"))for(;this.getShapesAtPoint(h).some(t=>this.isShapeOfType(t,"frame")&&t.props.w===e.props.w&&t.props.h===e.props.h);)h.x+=t.w+16}let s=d.xu.Common((0,a.oA)(b.map(({id:e})=>this.getShapePageBounds(e)))).center,p=g.B.Sub(h,s);this.updateShapes(b.map(({id:e})=>{let t=this.getShape(e),i=this.getShapeParentTransform(e).decompose().rotation,s=g.B.Rot(p,-i);return{id:t.id,type:t.type,x:t.x+s.x,y:t.y+s.y}}))}),this}async getSvg(e,t={}){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(0===i.length)return;if(!window.document)throw Error("No document");let{scale:s=1,background:a=!1,padding:n=p.s_,preserveAspectRatio:h=!1}=t,o=t.darkMode??this.user.getIsDarkMode(),d=(0,r.y6)({isDarkMode:o}),l=this.getShapeAndDescendantIds(i),g=this.getUnorderedRenderingShapes(!1).filter(({id:e})=>l.has(e)),u=null;if(t.bounds)u=t.bounds;else for(let{maskedPageBounds:e}of g)e&&(u?u.union(e):u=e.clone());if(!u)return;let c=1===i.length&&this.isShapeOfType(this.getShape(i[0]),"frame")?i[0]:null;c||u.expandBy(n);let S=u.width*s,f=u.height*s,m=window.document.createElementNS("http://www.w3.org/2000/svg","svg");h&&m.setAttribute("preserveAspectRatio",h),m.setAttribute("direction","ltr"),m.setAttribute("width",S+""),m.setAttribute("height",f+""),m.setAttribute("viewBox",`${u.minX} ${u.minY} ${u.width} ${u.height}`),m.setAttribute("stroke-linecap","round"),m.setAttribute("stroke-linejoin","round"),a?c?m.style.setProperty("background",d.solid):m.style.setProperty("background-color",d.background):m.style.setProperty("background-color","transparent");try{document.body.focus?.()}catch(e){}let y=window.document.createElementNS("http://www.w3.org/2000/svg","defs");m.append(y);let I=new Map,P={isDarkMode:o,addExportDef:e=>{if(I.has(e.key))return;let t=(async()=>{let t=await e.getElement();if(!t)return;let i=document.createComment(`def: ${e.key}`);for(let e of(y.appendChild(i),Array.isArray(t)?t:[t]))y.appendChild(e)})();I.set(e.key,t)}},C=(await Promise.all(g.map(async({id:e,opacity:t,index:i,backgroundIndex:s})=>{if(e===c)return[];let r=this.getShape(e);if(this.isShapeOfType(r,"group"))return[];let a=this.getShapeUtil(r),n=await a.toSvg?.(r,P),h=await a.toBackgroundSvg?.(r,P);if(n){let e=document.createElementNS("http://www.w3.org/2000/svg","g");e.appendChild(n),n=e}if(h){let e=document.createElementNS("http://www.w3.org/2000/svg","g");e.appendChild(h),h=e}if(!n&&!h){let e=this.getShapePageBounds(r),t=window.document.createElementNS("http://www.w3.org/2000/svg","rect");t.setAttribute("width",e.width+""),t.setAttribute("height",e.height+""),t.setAttribute("fill",d.solid),t.setAttribute("stroke",d.grey.pattern),t.setAttribute("stroke-width","1"),n=t}let o=this.getShapePageTransform(r).toCssString();"scale"in r.props&&1!==r.props.scale&&(o=`${o} scale(${r.props.scale}, ${r.props.scale})`),n?.setAttribute("transform",o),h?.setAttribute("transform",o),n?.setAttribute("opacity",t+""),h?.setAttribute("opacity",t+"");let p=this.getShapeMask(r.id);if(p){let e=document.createElementNS("http://www.w3.org/2000/svg","clipPath");y.appendChild(e);let t=(0,w.E)();e.id=t;let i=document.createElementNS("http://www.w3.org/2000/svg","path");if(i.setAttribute("d",`M${p.map(({x:e,y:t})=>`${e},${t}`).join("L")}Z`),e.appendChild(i),n){let e=document.createElementNS("http://www.w3.org/2000/svg","g");e.setAttribute("clip-path",`url(#${t})`),e.appendChild(n),n=e}if(h){let e=document.createElementNS("http://www.w3.org/2000/svg","g");e.setAttribute("clip-path",`url(#${t})`),e.appendChild(h),h=e}}let l=[];return n&&l.push({zIndex:i,element:n}),h&&l.push({zIndex:s,element:h}),l}))).flat();for(let{element:e}of(await Promise.all(I.values()),C.sort((e,t)=>e.zIndex-t.zIndex)))m.appendChild(e);return m}inputs={originPagePoint:new g.B,originScreenPoint:new g.B,previousPagePoint:new g.B,previousScreenPoint:new g.B,currentPagePoint:new g.B,currentScreenPoint:new g.B,keys:new Set,buttons:new Set,isPen:!1,shiftKey:!1,ctrlKey:!1,altKey:!1,isDragging:!1,isPointing:!1,isPinching:!1,isEditing:!1,isPanning:!1,pointerVelocity:new g.B};_updateInputsFromEvent(e){let{previousScreenPoint:t,previousPagePoint:i,currentScreenPoint:s,currentPagePoint:a}=this.inputs,{screenBounds:n}=this.store.unsafeGetWithoutCapture(r.PQ),{x:h,y:o,z:d}=this.getCamera(),l=e.point.x-n.x,g=e.point.y-n.y,u=e.point.z;t.setTo(s),i.setTo(a),s.set(l,g),a.set(l/d-h,g/d-o,u??.5),this.inputs.isPen="pointer"===e.type&&e.isPen,"pointer_down"===e.name&&this.inputs.pointerVelocity.set(0,0),this.store.put([{id:r.LV,typeName:"pointer",x:a.x,y:a.y,lastActivityTimestamp:"pointer"===e.type&&e.pointerId===p.CK.CAMERA_MOVE?this.store.get(r.LV)?.lastActivityTimestamp??Date.now():Date.now(),meta:{}}])}cancel(){return this.dispatch({type:"misc",name:"cancel"}),this}interrupt(){return this.dispatch({type:"misc",name:"interrupt"}),this}complete(){return this.dispatch({type:"misc",name:"complete"}),this}_clickManager=new v.o(this);cancelDoubleClick(){this._clickManager.cancelDoubleClickTimeout()}_prevCursor="default";_shiftKeyTimeout=-1;_setShiftKeyTimeout=()=>{this.inputs.shiftKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Shift",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"ShiftLeft"})};_altKeyTimeout=-1;_setAltKeyTimeout=()=>{this.inputs.altKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Alt",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"AltLeft"})};_ctrlKeyTimeout=-1;_setCtrlKeyTimeout=()=>{this.inputs.ctrlKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Ctrl",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"ControlLeft"})};_restoreToolId="select";_pinchStart=1;_didPinch=!1;_selectedShapeIdsAtPointerDown=[];capturedPointerId=null;dispatch=e=>{if(this.getCrashingError())return this;let{inputs:t}=this,{type:i}=e;return this.batch(()=>{if("misc"===e.type){("cancel"===e.name||"complete"===e.name)&&(this.inputs.isDragging=!1,this.inputs.isPanning&&(this.inputs.isPanning=!1,this.updateInstanceState({cursor:{type:this._prevCursor,rotation:0}}))),this.root.handleEvent(e);return}e.shiftKey?(clearInterval(this._shiftKeyTimeout),this._shiftKeyTimeout=-1,t.shiftKey=!0):!e.shiftKey&&t.shiftKey&&-1===this._shiftKeyTimeout&&(this._shiftKeyTimeout=setTimeout(this._setShiftKeyTimeout,150)),e.altKey?(clearInterval(this._altKeyTimeout),this._altKeyTimeout=-1,t.altKey=!0):!e.altKey&&t.altKey&&-1===this._altKeyTimeout&&(this._altKeyTimeout=setTimeout(this._setAltKeyTimeout,150)),e.ctrlKey?(clearInterval(this._ctrlKeyTimeout),this._ctrlKeyTimeout=-1,t.ctrlKey=!0):!e.ctrlKey&&t.ctrlKey&&-1===this._ctrlKeyTimeout&&(this._ctrlKeyTimeout=setTimeout(this._setCtrlKeyTimeout,150));let{originPagePoint:s,originScreenPoint:a,currentPagePoint:n,currentScreenPoint:h}=t;switch(t.isPointing||(t.isDragging=!1),i){case"pinch":if(!this.getInstanceState().canMoveCamera)return;switch(this._updateInputsFromEvent(e),e.name){case"pinch_start":if(t.isPinching)return;t.isEditing||(this._pinchStart=this.getCamera().z,this._selectedShapeIdsAtPointerDown.length||(this._selectedShapeIdsAtPointerDown=this.getSelectedShapeIds()),this._didPinch=!0,t.isPinching=!0,this.interrupt());return;case"pinch":{if(!t.isPinching)return;let{point:{z:i=1},delta:{x:s,y:a}}=e,{screenBounds:n}=this.store.unsafeGetWithoutCapture(r.PQ),{x:h,y:o}=g.B.SubXY(e.point,n.x,n.y),{x:d,y:l,z:u}=this.getCamera(),c=Math.min(p.sZ,Math.max(p.Zj,i));this.setCamera({x:d+s/u-h/u+h/c,y:l+a/u-o/u+o/c,z:c});return}case"pinch_end":{if(!t.isPinching)return this;t.isPinching=!1;let{_selectedShapeIdsAtPointerDown:e}=this;this.setSelectedShapes(this._selectedShapeIdsAtPointerDown,{squashing:!0}),this._selectedShapeIdsAtPointerDown=[],this._didPinch&&(this._didPinch=!1,requestAnimationFrame(()=>{this._didPinch||this.setSelectedShapes(e,{squashing:!0})}));return}}case"wheel":if(!this.getInstanceState().canMoveCamera)return;if(this._updateInputsFromEvent(e),this.getIsMenuOpen());else{if(t.ctrlKey){let{x:t,y:i}=this.inputs.currentScreenPoint,{x:s,y:r,z:a}=this.getCamera(),n=Math.min(p.sZ,Math.max(p.Zj,a+(e.delta.z??0)*a));this.setCamera({x:s+(t/n-t)-(t/a-t),y:r+(i/n-i)-(i/a-i),z:n});return}this.pan(e.delta),!t.isDragging&&t.isPointing&&s.dist(n)>(this.getInstanceState().isCoarsePointer?p.UD:p.Sk)/this.getZoomLevel()&&(t.isDragging=!0)}break;case"pointer":{if(t.isPinching)return;this._updateInputsFromEvent(e);let{isPen:i}=e;switch(e.name){case"pointer_down":if(this.clearOpenMenus(),this._selectedShapeIdsAtPointerDown=this.getSelectedShapeIds(),0===e.button&&(this.capturedPointerId=e.pointerId),t.buttons.add(e.button),t.isPointing=!0,t.isDragging=!1,this.getInstanceState().isPenMode){if(!i)return}else i&&this.updateInstanceState({isPenMode:!0});if(5===e.button?(this._restoreToolId=this.getCurrentToolId(),this.complete(),this.setCurrentTool("eraser")):1===e.button&&(this.inputs.isPanning||(this._prevCursor=this.getInstanceState().cursor.type),this.inputs.isPanning=!0),this.inputs.isPanning)return this.stopCameraAnimation(),this.updateInstanceState({cursor:{type:"grabbing",rotation:0}}),this;a.setTo(h),s.setTo(n);break;case"pointer_move":if(!i&&this.getInstanceState().isPenMode)return;if(this.inputs.isPanning&&this.inputs.isPointing){let{currentScreenPoint:e,previousScreenPoint:t}=this.inputs;this.pan(g.B.Sub(e,t));return}!t.isDragging&&t.isPointing&&s.dist(n)>(this.getInstanceState().isCoarsePointer?p.UD:p.Sk)/this.getZoomLevel()&&(t.isDragging=!0);break;case"pointer_up":if(t.buttons.delete(e.button),t.isPointing=!1,t.isDragging=!1,this.getIsMenuOpen()||!i&&this.getInstanceState().isPenMode)return;this.capturedPointerId===e.pointerId&&(this.capturedPointerId=null,e.button=0),t.isPanning?1===e.button?this.inputs.keys.has(" ")?(this.slideCamera({speed:Math.min(2,this.inputs.pointerVelocity.len()),direction:this.inputs.pointerVelocity,friction:p.$G}),this.updateInstanceState({cursor:{type:"grab",rotation:0}})):(t.isPanning=!1,this.slideCamera({speed:Math.min(2,this.inputs.pointerVelocity.len()),direction:this.inputs.pointerVelocity,friction:p.$G}),this.updateInstanceState({cursor:{type:this._prevCursor,rotation:0}})):0===e.button&&(this.slideCamera({speed:Math.min(2,this.inputs.pointerVelocity.len()),direction:this.inputs.pointerVelocity,friction:p.$G}),this.updateInstanceState({cursor:{type:"grab",rotation:0}})):5===e.button&&(this.complete(),this.setCurrentTool(this._restoreToolId))}break}case"keyboard":switch("ShiftRight"===e.key&&(e.key="ShiftLeft"),"AltRight"===e.key&&(e.key="AltLeft"),"ControlRight"===e.code&&(e.code="ControlLeft"),e.name){case"key_down":t.keys.add(e.code),e.ctrlKey||"Space"!==e.code||(this.inputs.isPanning||(this._prevCursor=this.getInstanceState().cursor.type),this.inputs.isPanning=!0,this.updateInstanceState({cursor:{type:this.inputs.isPointing?"grabbing":"grab",rotation:0}}));break;case"key_up":t.keys.delete(e.code),"Space"!==e.code||this.inputs.buttons.has(1)||(this.inputs.isPanning=!1,this.updateInstanceState({cursor:{type:this._prevCursor,rotation:0}}))}}if("pointer"===e.type&&(1===e.button?e.name="middle_click":2===e.button&&(e.name="right_click"),e.isPen===this.getInstanceState().isPenMode))switch(e.name){case"pointer_down":{let t=this._clickManager.transformPointerDownEvent(e);if(e.name!==t.name){this.root.handleEvent(e),this.emit("event",e),this.root.handleEvent(t),this.emit("event",t);return}break}case"pointer_up":{let t=this._clickManager.transformPointerUpEvent(e);if(e.name!==t.name){this.root.handleEvent(e),this.emit("event",e),this.root.handleEvent(t),this.emit("event",t);return}break}case"pointer_move":this._clickManager.handleMove()}this.root.handleEvent(e),this.emit("event",e)}),this}};function alertMaxShapes(e,t=e.getCurrentPageId()){let i=e.getPage(t).name;e.emit("max-shapes",{name:i,pageId:t,count:p.kx})}function applyPartialToShape(e,t){if(!t)return e;let i=null,s=Object.entries(t);for(let t=0,r=s.length;t<r;t++){let[r,a]=s[t];if(void 0!==a&&"id"!==r&&"type"!==r&&"typeName"!==r&&a!==e[r]){if(i||(i={...e}),"props"===r||"meta"===r){for(let[t,s]of(i[r]={...e[r]},Object.entries(a)))void 0!==s&&(i[r][t]=s);continue}i[r]=a}}return i||e}__decorateClass([s.Fl],Editor.prototype,"getCanUndo",1),__decorateClass([s.Fl],Editor.prototype,"getCanRedo",1),__decorateClass([s.Fl],Editor.prototype,"_getArrowBindingsIndex",1),__decorateClass([s.Fl],Editor.prototype,"getArrowInfoCache",1),__decorateClass([s.Fl],Editor.prototype,"getPath",1),__decorateClass([s.Fl],Editor.prototype,"getCurrentTool",1),__decorateClass([s.Fl],Editor.prototype,"getCurrentToolId",1),__decorateClass([s.Fl],Editor.prototype,"getDocumentSettings",1),__decorateClass([s.Fl],Editor.prototype,"getInstanceState",1),__decorateClass([s.Fl],Editor.prototype,"getOpenMenus",1),__decorateClass([s.Fl],Editor.prototype,"getIsMenuOpen",1),__decorateClass([s.Fl],Editor.prototype,"getPageStates",1),__decorateClass([s.Fl],Editor.prototype,"_getPageStatesQuery",1),__decorateClass([s.Fl],Editor.prototype,"getCurrentPageState",1),__decorateClass([s.Fl],Editor.prototype,"_getCurrentPageStateId",1),__decorateClass([s.Fl],Editor.prototype,"getSelectedShapeIds",1),__decorateClass([s.Fl],Editor.prototype,"getSelectedShapes",1),__decorateClass([s.Fl],Editor.prototype,"getOnlySelectedShape",1),__decorateClass([s.Fl],Editor.prototype,"getSelectionPageBounds",1),__decorateClass([s.Fl],Editor.prototype,"getSelectionRotation",1),__decorateClass([s.Fl],Editor.prototype,"getSelectionRotatedPageBounds",1),__decorateClass([s.Fl],Editor.prototype,"getFocusedGroupId",1),__decorateClass([s.Fl],Editor.prototype,"getFocusedGroup",1),__decorateClass([s.Fl],Editor.prototype,"getEditingShapeId",1),__decorateClass([s.Fl],Editor.prototype,"getEditingShape",1),__decorateClass([s.Fl],Editor.prototype,"getHoveredShapeId",1),__decorateClass([s.Fl],Editor.prototype,"getHoveredShape",1),__decorateClass([s.Fl],Editor.prototype,"getHintingShapeIds",1),__decorateClass([s.Fl],Editor.prototype,"getHintingShape",1),__decorateClass([s.Fl],Editor.prototype,"getErasingShapeIds",1),__decorateClass([s.Fl],Editor.prototype,"getErasingShapes",1),__decorateClass([s.Fl],Editor.prototype,"getCameraId",1),__decorateClass([s.Fl],Editor.prototype,"getCamera",1),__decorateClass([s.Fl],Editor.prototype,"getZoomLevel",1),__decorateClass([s.Fl],Editor.prototype,"getViewportScreenBounds",1),__decorateClass([s.Fl],Editor.prototype,"getViewportScreenCenter",1),__decorateClass([s.Fl],Editor.prototype,"getViewportPageBounds",1),__decorateClass([s.Fl],Editor.prototype,"getViewportPageCenter",1),__decorateClass([s.Fl],Editor.prototype,"getRenderingShapes",1),__decorateClass([s.Fl],Editor.prototype,"_getAllPagesQuery",1),__decorateClass([s.Fl],Editor.prototype,"getPages",1),__decorateClass([s.Fl],Editor.prototype,"_getAllAssetsQuery",1),__decorateClass([s.Fl],Editor.prototype,"_getShapeGeometryCache",1),__decorateClass([s.Fl],Editor.prototype,"_getShapeHandlesCache",1),__decorateClass([s.Fl],Editor.prototype,"_getShapePageTransformCache",1),__decorateClass([s.Fl],Editor.prototype,"_getShapePageBoundsCache",1),__decorateClass([s.Fl],Editor.prototype,"_getShapeClipPathCache",1),__decorateClass([s.Fl],Editor.prototype,"_getShapeMaskCache",1),__decorateClass([s.Fl],Editor.prototype,"getCurrentPageBounds",1),__decorateClass([s.Fl],Editor.prototype,"getCurrentPageShapes",1),__decorateClass([s.Fl],Editor.prototype,"getCurrentPageShapesSorted",1),__decorateClass([s.Fl],Editor.prototype,"getCurrentPageRenderingShapesSorted",1),__decorateClass([s.Fl],Editor.prototype,"_getSelectionSharedStyles",1),__decorateClass([(0,s.Fl)({isEqual:(e,t)=>e.equals(t)})],Editor.prototype,"getSharedStyles",1),__decorateClass([s.Fl],Editor.prototype,"getSharedOpacity",1)}}]);